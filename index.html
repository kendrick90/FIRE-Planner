<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIRE Financial Planner</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #e6edf3;
            line-height: 1.5;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #58a6ff;
            margin-bottom: 24px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .top-section {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        @media (max-width: 900px) {
            .top-section {
                grid-template-columns: 1fr;
            }
        }
        .inputs-panel {
            background: #161b22;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #30363d;
        }
        .inputs-panel h2 {
            font-size: 16px;
            color: #58a6ff;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #238636;
        }
        .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .input-row label {
            font-size: 14px;
            color: #8b949e;
        }
        .input-row input {
            width: 110px;
            padding: 6px 8px;
            border: 1px solid #30363d;
            border-radius: 4px;
            font-size: 14px;
            text-align: right;
            background: #0d1117;
            color: #e6edf3;
            -moz-appearance: textfield;
        }
        .input-row input::-webkit-outer-spin-button,
        .input-row input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .input-row input:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2);
        }
        .input-with-buttons {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .input-with-buttons input {
            width: 88px;
        }
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .inc-btn {
            width: 22px;
            height: 13px;
            padding: 0;
            margin: 0;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 3px;
            color: #8b949e;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .inc-btn:hover {
            background: #30363d;
            color: #e6edf3;
        }
        .inc-btn:active {
            background: #238636;
        }
        .inc-btn.auto-btn {
            width: auto;
            height: 28px;
            padding: 0 10px;
            font-size: 12px;
        }
        .input-section {
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #30363d;
        }
        .input-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .input-section-title {
            font-size: 12px;
            font-weight: 600;
            color: #8b949e;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .chart-panel {
            background: #161b22;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #30363d;
        }
        .chart-container {
            position: relative;
            height: 220px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 16px;
        }
        .chart-panel h3 {
            font-size: 14px;
            color: #8b949e;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        .chart-controls {
            font-weight: normal;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .chart-controls input {
            width: 88px;
            padding: 6px 8px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            color: #e6edf3;
            font-size: 14px;
            text-align: right;
        }
        .table-section {
            background: #161b22;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #30363d;
            overflow-x: auto;
        }
        .table-section h2 {
            font-size: 16px;
            color: #58a6ff;
            margin-bottom: 16px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th, td {
            padding: 8px 12px;
            text-align: right;
            border-bottom: 1px solid #30363d;
            white-space: nowrap;
        }
        th {
            background: #21262d;
            font-weight: 600;
            color: #8b949e;
            position: sticky;
            top: 0;
        }
        th:first-child, td:first-child,
        th:nth-child(2), td:nth-child(2),
        th:nth-child(3), td:nth-child(3) {
            text-align: left;
        }
        tr:hover {
            background: #1f2937;
        }
        .phase-save { color: #58a6ff; }
        .phase-buy { color: #d29922; }
        .phase-mortgage { color: #a371f7; }
        .phase-own { color: #56d4dd; }
        .phase-retire { color: #3fb950; }
        .phase-ss { color: #39d353; }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .summary-card {
            background: #161b22;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #30363d;
        }
        .summary-card .label {
            font-size: 12px;
            color: #8b949e;
            text-transform: uppercase;
        }
        .summary-card .value {
            font-size: 24px;
            font-weight: 600;
            color: #58a6ff;
        }
        .summary-card .sub {
            font-size: 12px;
            color: #8b949e;
        }
        .negative { color: #f85149; }
        .positive { color: #3fb950; }

        /* Custom scrollbar */
        .table-section ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .table-section ::-webkit-scrollbar-track {
            background: #161b22;
            border-radius: 4px;
        }
        .table-section ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }
        .table-section ::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }
        .table-section {
            scrollbar-width: thin;
            scrollbar-color: #30363d #161b22;
        }
        .table-section > div {
            padding-right: 12px;
        }

        /* Scenario Management Styles */
        .scenario-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 12px 16px;
            background: #161b22;
            border-radius: 8px;
            border: 1px solid #30363d;
            flex-wrap: wrap;
        }
        .scenario-bar label {
            font-size: 14px;
            color: #8b949e;
            font-weight: 500;
        }
        .scenario-select {
            flex: 1;
            min-width: 200px;
            max-width: 400px;
            padding: 8px 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #e6edf3;
            font-size: 14px;
            cursor: pointer;
        }
        .scenario-select:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2);
        }
        .scenario-btn {
            padding: 8px 12px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #e6edf3;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.15s, border-color 0.15s;
        }
        .scenario-btn:hover {
            background: #30363d;
            border-color: #484f58;
        }
        .scenario-btn.primary {
            background: #238636;
            border-color: #238636;
        }
        .scenario-btn.primary:hover {
            background: #2ea043;
            border-color: #2ea043;
        }
        .scenario-btn.danger {
            color: #f85149;
        }
        .scenario-btn.danger:hover {
            background: #f8514922;
            border-color: #f85149;
        }
        .scenario-btn svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }
        .scenario-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .scenario-divider {
            width: 1px;
            height: 24px;
            background: #30363d;
        }
        .scenario-meta {
            font-size: 11px;
            color: #8b949e;
            margin-left: auto;
        }
        @media (max-width: 1100px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 900px) {
            .scenario-bar {
                flex-direction: column;
                align-items: stretch;
            }
            .scenario-select {
                max-width: none;
            }
            .scenario-actions {
                justify-content: center;
            }
            .scenario-divider {
                display: none;
            }
            .scenario-meta {
                margin-left: 0;
                text-align: center;
            }
        }
        @media (max-width: 600px) {
            .chart-controls input {
                width: 70px;
                font-size: 12px;
                padding: 4px 6px;
            }
            .chart-controls {
                font-size: 11px;
            }
        }
        @media (max-width: 400px) {
            .chart-container {
                height: 180px;
            }
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }
        .modal h3 {
            color: #e6edf3;
            margin-bottom: 16px;
            font-size: 18px;
        }
        .modal-input {
            width: 100%;
            padding: 10px 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #e6edf3;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .modal-input:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2);
        }
        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .modal-text {
            color: #8b949e;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .modal-text strong {
            color: #e6edf3;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 12px 20px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            color: #e6edf3;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
            z-index: 1001;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        .toast.success {
            border-color: #238636;
        }
        .toast.error {
            border-color: #f85149;
        }

        /* Hidden file input for import */
        .hidden-input {
            display: none;
        }

        /* Unsaved changes indicator */
        .unsaved-indicator {
            font-size: 12px;
            color: #d29922;
            background: rgba(210, 153, 34, 0.15);
            padding: 4px 10px;
            border-radius: 12px;
            border: 1px solid rgba(210, 153, 34, 0.4);
        }

        /* Save button states */
        .save-btn.has-changes {
            background: #238636;
            border-color: #238636;
            animation: pulse-save 2s infinite;
        }
        .save-btn.has-changes:hover {
            background: #2ea043;
            border-color: #2ea043;
        }
        @keyframes pulse-save {
            0%, 100% { box-shadow: 0 0 0 0 rgba(35, 134, 54, 0.4); }
            50% { box-shadow: 0 0 0 4px rgba(35, 134, 54, 0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>FIRE Financial Planner</h1>

        <!-- Scenario Management Bar -->
        <div class="scenario-bar">
            <label for="scenarioSelect">Scenario:</label>
            <select id="scenarioSelect" class="scenario-select" onchange="confirmSwitchScenario(this.value)">
                <option value="">Loading...</option>
            </select>
            <span id="unsavedIndicator" class="unsaved-indicator" style="display: none;">Unsaved changes</span>
            <div class="scenario-actions">
                <button id="saveBtn" class="scenario-btn save-btn" onclick="saveScenario()" title="Save Current Scenario">
                    <svg viewBox="0 0 16 16"><path d="M.5 1.75A1.75 1.75 0 0 1 2.25 0h8.5a.75.75 0 0 1 .53.22l3.5 3.5a.75.75 0 0 1 .22.53v10.5A1.75 1.75 0 0 1 13.25 16H2.25A1.75 1.75 0 0 1 .5 14.25Zm2.25-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h1.75v-4.25A1.75 1.75 0 0 1 5.75 8.5h4.5a1.75 1.75 0 0 1 1.75 1.75v4.25h1.25a.25.25 0 0 0 .25-.25V4.81L10.69 2.5H10v2.25A1.75 1.75 0 0 1 8.25 6.5h-3.5A1.75 1.75 0 0 1 3 4.75V1.5Zm5.5 0h-4v3.25c0 .138.112.25.25.25h3.5a.25.25 0 0 0 .25-.25Zm-1.5 8.5h-1.5a.25.25 0 0 0-.25.25v4.25h4v-4.25a.25.25 0 0 0-.25-.25Z"/></svg>
                    Save
                </button>
                <button class="scenario-btn primary" onclick="createNewScenario()" title="Create New Scenario">
                    <svg viewBox="0 0 16 16"><path d="M8 0a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2H9v6a1 1 0 1 1-2 0V9H1a1 1 0 0 1 0-2h6V1a1 1 0 0 1 1-1z"/></svg>
                    New
                </button>
                <button class="scenario-btn" onclick="duplicateScenario()" title="Duplicate Current Scenario">
                    <svg viewBox="0 0 16 16"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"/></svg>
                    Duplicate
                </button>
                <button class="scenario-btn" onclick="showRenameModal()" title="Rename Current Scenario">
                    <svg viewBox="0 0 16 16"><path d="M11.013 1.427a1.75 1.75 0 0 1 2.474 0l1.086 1.086a1.75 1.75 0 0 1 0 2.474l-8.61 8.61c-.21.21-.47.364-.756.445l-3.251.93a.75.75 0 0 1-.927-.928l.929-3.25c.081-.286.235-.547.445-.758l8.61-8.61Zm.176 4.823L9.75 4.81l-6.286 6.287a.253.253 0 0 0-.064.108l-.558 1.953 1.953-.558a.253.253 0 0 0 .108-.064Zm1.238-3.763a.25.25 0 0 0-.354 0L10.811 3.75l1.439 1.44 1.263-1.263a.25.25 0 0 0 0-.354Z"/></svg>
                    Rename
                </button>
                <button class="scenario-btn danger" onclick="showDeleteModal()" title="Delete Current Scenario">
                    <svg viewBox="0 0 16 16"><path d="M11 1.75V3h2.25a.75.75 0 0 1 0 1.5H2.75a.75.75 0 0 1 0-1.5H5V1.75C5 .784 5.784 0 6.75 0h2.5C10.216 0 11 .784 11 1.75ZM4.496 6.675l.66 6.6a.25.25 0 0 0 .249.225h5.19a.25.25 0 0 0 .249-.225l.66-6.6a.75.75 0 0 1 1.492.149l-.66 6.6A1.748 1.748 0 0 1 10.595 15h-5.19a1.75 1.75 0 0 1-1.741-1.575l-.66-6.6a.75.75 0 1 1 1.492-.15ZM6.5 1.75V3h3V1.75a.25.25 0 0 0-.25-.25h-2.5a.25.25 0 0 0-.25.25Z"/></svg>
                    Delete
                </button>
            </div>
            <div class="scenario-divider"></div>
            <div class="scenario-actions">
                <button class="scenario-btn" onclick="exportScenarios()" title="Export Scenarios">
                    <svg viewBox="0 0 16 16"><path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z"/><path d="M7.25 7.689V2a.75.75 0 0 1 1.5 0v5.689l1.97-1.969a.749.749 0 1 1 1.06 1.06l-3.25 3.25a.749.749 0 0 1-1.06 0L4.22 6.78a.749.749 0 1 1 1.06-1.06l1.97 1.969Z"/></svg>
                    Export
                </button>
                <button class="scenario-btn" onclick="document.getElementById('importFile').click()" title="Import Scenarios">
                    <svg viewBox="0 0 16 16"><path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z"/><path d="M11.78 4.72a.749.749 0 1 1-1.06 1.06L8.75 3.811V9.5a.75.75 0 0 1-1.5 0V3.811L5.28 5.78a.749.749 0 1 1-1.06-1.06l3.25-3.25a.749.749 0 0 1 1.06 0l3.25 3.25Z"/></svg>
                    Import
                </button>
            </div>
            <span class="scenario-meta" id="scenarioMeta"></span>
        </div>
        <input type="file" id="importFile" class="hidden-input" accept=".json" onchange="importScenarios(event)">

        <!-- Rename Modal -->
        <div id="renameModal" class="modal-overlay" onclick="closeModalOnOverlay(event, 'renameModal')">
            <div class="modal">
                <h3>Rename Scenario</h3>
                <input type="text" id="renameInput" class="modal-input" placeholder="Enter scenario name" onkeydown="if(event.key==='Enter') confirmRename()">
                <div class="modal-buttons">
                    <button class="scenario-btn" onclick="closeModal('renameModal')">Cancel</button>
                    <button class="scenario-btn primary" onclick="confirmRename()">Rename</button>
                </div>
            </div>
        </div>

        <!-- Delete Modal -->
        <div id="deleteModal" class="modal-overlay" onclick="closeModalOnOverlay(event, 'deleteModal')">
            <div class="modal">
                <h3>Delete Scenario</h3>
                <p class="modal-text">Are you sure you want to delete <strong id="deleteScenarioName"></strong>? This action cannot be undone.</p>
                <div class="modal-buttons">
                    <button class="scenario-btn" onclick="closeModal('deleteModal')">Cancel</button>
                    <button class="scenario-btn danger" onclick="confirmDelete()">Delete</button>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="toast"></div>

        <div class="summary-cards" id="summaryCards"></div>

        <div class="top-section">
            <div class="inputs-panel">
                <h2>Inputs</h2>

                <div class="input-section">
                    <div class="input-section-title">Personal</div>
                    <div class="input-row">
                        <label>Current Age</label>
                        <div class="input-with-buttons">
                            <input type="number" id="currentAge" value="18">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustNum('currentAge', 1)">+</button>
                                <button class="inc-btn" onclick="adjustNum('currentAge', -1)">−</button>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <label>Retirement Age</label>
                        <div class="input-with-buttons">
                            <input type="number" id="retirementAge" value="38">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustNum('retirementAge', 1)">+</button>
                                <button class="inc-btn" onclick="adjustNum('retirementAge', -1)">−</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="input-section">
                    <div class="input-section-title">Savings & Returns</div>
                    <div class="input-row">
                        <label>Initial Balance</label>
                        <div class="input-with-buttons">
                            <input type="text" id="initialBalance" value="1000">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustValue('initialBalance', 1000)">+</button>
                                <button class="inc-btn" onclick="adjustValue('initialBalance', -1000)">−</button>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <label>Monthly Savings</label>
                        <div class="input-with-buttons">
                            <input type="text" id="monthlySavings" value="4000">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustValue('monthlySavings', 500)">+</button>
                                <button class="inc-btn" onclick="adjustValue('monthlySavings', -500)">−</button>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <label>Annual Return</label>
                        <div class="input-with-buttons">
                            <input type="text" id="annualReturn" value="5%">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustPercent('annualReturn', 0.5)">+</button>
                                <button class="inc-btn" onclick="adjustPercent('annualReturn', -0.5)">−</button>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <label>Monthly Withdrawal</label>
                        <div class="input-with-buttons">
                            <input type="text" id="monthlyWithdrawal" value="4000">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustValue('monthlyWithdrawal', 500)">+</button>
                                <button class="inc-btn" onclick="adjustValue('monthlyWithdrawal', -500)">−</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="input-section">
                    <div class="input-section-title">Home Purchase</div>
                    <div class="input-row">
                        <label>House Purchase Age</label>
                        <div class="input-with-buttons">
                            <input type="number" id="houseAge" value="30">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustNum('houseAge', 1)">+</button>
                                <button class="inc-btn" onclick="adjustNum('houseAge', -1)">−</button>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <label>House Price</label>
                        <div class="input-with-buttons">
                            <input type="text" id="housePrice" value="500000">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustValue('housePrice', 1000)">+</button>
                                <button class="inc-btn" onclick="adjustValue('housePrice', -1000)">−</button>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <label>Down Payment</label>
                        <div class="input-with-buttons">
                            <input type="text" id="downPayment" value="100000">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustValue('downPayment', 1000)">+</button>
                                <button class="inc-btn" onclick="adjustValue('downPayment', -1000)">−</button>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <label>Mortgage Rate</label>
                        <div class="input-with-buttons">
                            <input type="text" id="mortgageRate" value="6%">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustPercent('mortgageRate', 0.25)">+</button>
                                <button class="inc-btn" onclick="adjustPercent('mortgageRate', -0.25)">−</button>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <label>Mortgage Term (yrs)</label>
                        <div class="input-with-buttons">
                            <input type="number" id="mortgageTerm" value="30">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustNum('mortgageTerm', 5)">+</button>
                                <button class="inc-btn" onclick="adjustNum('mortgageTerm', -5)">−</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="input-section">
                    <div class="input-section-title">Social Security</div>
                    <div class="input-row">
                        <label>Annual SS Benefit</label>
                        <div class="input-with-buttons">
                            <input type="text" id="socialSecurity" value="24000">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustValue('socialSecurity', 1000)">+</button>
                                <button class="inc-btn" onclick="adjustValue('socialSecurity', -1000)">−</button>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <label>SS Start Age</label>
                        <div class="input-with-buttons">
                            <input type="number" id="ssAge" value="62">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustNum('ssAge', 1)">+</button>
                                <button class="inc-btn" onclick="adjustNum('ssAge', -1)">−</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-panel">
                    <h3>
                        <span>Portfolio Balance</span>
                        <span class="chart-controls">
                            Y-Max: <input type="text" id="yAxisMax" value="$2,000,000" placeholder="Auto">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustYMax(1)">+</button>
                                <button class="inc-btn" onclick="adjustYMax(-1)">−</button>
                            </div>
                            <button class="inc-btn auto-btn" onclick="clearYMax()">Auto</button>
                        </span>
                    </h3>
                    <div class="chart-container">
                        <canvas id="balanceChart"></canvas>
                    </div>
                </div>
                <div class="chart-panel">
                    <h3>
                        <span>Annual Cash Flows</span>
                        <span class="chart-controls">
                            Y-Max: <input type="text" id="cashFlowYMax" value="$200,000" placeholder="Auto">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustCashFlowYMax(1)">+</button>
                                <button class="inc-btn" onclick="adjustCashFlowYMax(-1)">−</button>
                            </div>
                            <button class="inc-btn auto-btn" onclick="clearCashFlowYMax()">Auto</button>
                        </span>
                    </h3>
                    <div class="chart-container">
                        <canvas id="cashFlowChart"></canvas>
                    </div>
                </div>
                <div class="chart-panel">
                    <h3>Mortgage</h3>
                    <div class="chart-container">
                        <canvas id="mortgageChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-section">
            <h2>Year-by-Year Projection</h2>
            <div style="max-height: 500px; overflow-y: auto;">
                <table id="projectionTable">
                    <thead>
                        <tr>
                            <th>Year</th>
                            <th>Age</th>
                            <th>Phase</th>
                            <th>Start Balance</th>
                            <th>Gains</th>
                            <th>Cash In</th>
                            <th>Cash Out</th>
                            <th>End Balance</th>
                            <th>Mortgage Pmt</th>
                            <th>Mortgage Bal</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let balanceChart = null;
        let cashFlowChart = null;
        let mortgageChart = null;

        // Input field IDs (moved to top for scenario management)
        const inputIds = [
            'currentAge', 'retirementAge', 'initialBalance', 'monthlySavings',
            'annualReturn', 'monthlyWithdrawal', 'houseAge', 'housePrice',
            'downPayment', 'mortgageRate', 'mortgageTerm', 'socialSecurity',
            'ssAge', 'yAxisMax', 'cashFlowYMax'
        ];

        const currencyInputs = [
            'initialBalance', 'monthlySavings', 'monthlyWithdrawal',
            'housePrice', 'downPayment', 'socialSecurity'
        ];

        // ========== SCENARIO MANAGEMENT SYSTEM ==========
        const SCENARIOS_KEY = 'fireScenarios';
        const CURRENT_SCENARIO_KEY = 'fireCurrentScenario';
        let currentScenarioId = null;
        let hasUnsavedChanges = false;
        let isLoadingScenario = false;

        // Generate unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        // Get all scenarios from storage
        function getScenarios() {
            const saved = localStorage.getItem(SCENARIOS_KEY);
            return saved ? JSON.parse(saved) : {};
        }

        // Save all scenarios to storage
        function saveScenarios(scenarios) {
            localStorage.setItem(SCENARIOS_KEY, JSON.stringify(scenarios));
        }

        // Get current input values as an object
        function getCurrentInputValues() {
            const data = {};
            inputIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) data[id] = el.value;
            });
            return data;
        }

        // Set input values from an object
        function setInputValues(data) {
            inputIds.forEach(id => {
                const el = document.getElementById(id);
                if (el && data[id] !== undefined) el.value = data[id];
            });
        }

        // Format date for display
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Update the scenario dropdown
        function updateScenarioDropdown() {
            const select = document.getElementById('scenarioSelect');
            const scenarios = getScenarios();
            const scenarioList = Object.values(scenarios).sort((a, b) => b.lastModified - a.lastModified);

            select.innerHTML = scenarioList.map(s =>
                `<option value="${s.id}" ${s.id === currentScenarioId ? 'selected' : ''}>${s.name}</option>`
            ).join('');

            updateScenarioMeta();
        }

        // Update scenario metadata display
        function updateScenarioMeta() {
            const meta = document.getElementById('scenarioMeta');
            const scenarios = getScenarios();
            const current = scenarios[currentScenarioId];
            if (current) {
                meta.textContent = `Last saved: ${formatDate(current.lastModified)}`;
            } else {
                meta.textContent = '';
            }
        }

        // Create a new scenario (with optional unsaved changes check)
        function createNewScenario(name = null, data = null, skipUnsavedCheck = false) {
            if (!skipUnsavedCheck && hasUnsavedChanges) {
                if (!confirm('You have unsaved changes. Discard them and create a new scenario?')) {
                    return null;
                }
            }
            clearUnsavedChanges();
            const scenarios = getScenarios();
            const id = generateId();
            const now = Date.now();

            // Default values for a new scenario
            const defaultData = {
                currentAge: '18',
                retirementAge: '38',
                initialBalance: '$1,000',
                monthlySavings: '$4,000',
                annualReturn: '5%',
                monthlyWithdrawal: '$4,000',
                houseAge: '30',
                housePrice: '$500,000',
                downPayment: '$100,000',
                mortgageRate: '6%',
                mortgageTerm: '30',
                socialSecurity: '$24,000',
                ssAge: '62',
                yAxisMax: '$2,000,000',
                cashFlowYMax: '$200,000'
            };

            // Generate unique name
            let baseName = name || 'New Scenario';
            let finalName = baseName;
            let counter = 1;
            const existingNames = Object.values(scenarios).map(s => s.name);
            while (existingNames.includes(finalName)) {
                counter++;
                finalName = `${baseName} ${counter}`;
            }

            scenarios[id] = {
                id,
                name: finalName,
                created: now,
                lastModified: now,
                data: data || defaultData
            };

            saveScenarios(scenarios);
            currentScenarioId = id;
            localStorage.setItem(CURRENT_SCENARIO_KEY, id);

            isLoadingScenario = true;
            setInputValues(scenarios[id].data);
            updateScenarioDropdown();
            calculate();
            isLoadingScenario = false;
            clearUnsavedChanges();

            showToast(`Created "${finalName}"`, 'success');
            return id;
        }

        // Load a scenario by ID
        function loadScenario(id) {
            const scenarios = getScenarios();
            if (!scenarios[id]) return;

            isLoadingScenario = true;

            currentScenarioId = id;
            localStorage.setItem(CURRENT_SCENARIO_KEY, id);

            setInputValues(scenarios[id].data);

            // Re-format currency inputs after loading
            currencyInputs.forEach(cid => {
                const input = document.getElementById(cid);
                if (input) input.value = formatCurrency(input.value);
            });

            updateScenarioMeta();
            calculate();

            isLoadingScenario = false;
            clearUnsavedChanges();
        }

        // Save current scenario
        function saveCurrentScenario() {
            if (!currentScenarioId) return;

            const scenarios = getScenarios();
            if (!scenarios[currentScenarioId]) return;

            scenarios[currentScenarioId].data = getCurrentInputValues();
            scenarios[currentScenarioId].lastModified = Date.now();

            saveScenarios(scenarios);
            updateScenarioMeta();
        }

        // Duplicate current scenario
        function duplicateScenario() {
            if (hasUnsavedChanges) {
                if (!confirm('You have unsaved changes. Discard them and duplicate the saved version?')) {
                    return;
                }
            }
            clearUnsavedChanges();

            const scenarios = getScenarios();
            const current = scenarios[currentScenarioId];
            if (!current) return;

            createNewScenario(current.name + ' (Copy)', { ...current.data }, true);
        }

        // Show rename modal
        function showRenameModal() {
            const scenarios = getScenarios();
            const current = scenarios[currentScenarioId];
            if (!current) return;

            document.getElementById('renameInput').value = current.name;
            document.getElementById('renameModal').classList.add('active');
            document.getElementById('renameInput').focus();
            document.getElementById('renameInput').select();
        }

        // Confirm rename
        function confirmRename() {
            const newName = document.getElementById('renameInput').value.trim();
            if (!newName) {
                showToast('Please enter a name', 'error');
                return;
            }

            const scenarios = getScenarios();
            if (!scenarios[currentScenarioId]) return;

            scenarios[currentScenarioId].name = newName;
            scenarios[currentScenarioId].lastModified = Date.now();
            saveScenarios(scenarios);

            updateScenarioDropdown();
            closeModal('renameModal');
            showToast('Scenario renamed', 'success');
        }

        // Show delete modal
        function showDeleteModal() {
            const scenarios = getScenarios();
            const current = scenarios[currentScenarioId];
            if (!current) return;

            // Don't allow deleting the last scenario
            if (Object.keys(scenarios).length <= 1) {
                showToast('Cannot delete the only scenario', 'error');
                return;
            }

            document.getElementById('deleteScenarioName').textContent = current.name;
            document.getElementById('deleteModal').classList.add('active');
        }

        // Confirm delete
        function confirmDelete() {
            const scenarios = getScenarios();
            if (!scenarios[currentScenarioId]) return;

            const deletedName = scenarios[currentScenarioId].name;
            delete scenarios[currentScenarioId];
            saveScenarios(scenarios);

            // Switch to another scenario
            const remaining = Object.values(scenarios).sort((a, b) => b.lastModified - a.lastModified);
            if (remaining.length > 0) {
                loadScenario(remaining[0].id);
            }

            updateScenarioDropdown();
            closeModal('deleteModal');
            showToast(`Deleted "${deletedName}"`, 'success');
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Close modal on overlay click
        function closeModalOnOverlay(event, modalId) {
            if (event.target.classList.contains('modal-overlay')) {
                closeModal(modalId);
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Export all scenarios
        function exportScenarios() {
            const scenarios = getScenarios();
            const currentScenario = scenarios[currentScenarioId];
            const scenarioName = currentScenario ? currentScenario.name.replace(/[^a-z0-9]/gi, '-').toLowerCase() : 'scenarios';
            const exportData = {
                version: 1,
                exportDate: new Date().toISOString(),
                currentScenarioId,
                scenarios
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fire-planner-${scenarioName}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast(`Exported ${Object.keys(scenarios).length} scenario(s)`, 'success');
        }

        // Import scenarios
        function importScenarios(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);

                    if (!importData.scenarios) {
                        throw new Error('Invalid file format');
                    }

                    const scenarios = getScenarios();
                    let importCount = 0;

                    // Import each scenario with a new ID to avoid conflicts
                    Object.values(importData.scenarios).forEach(scenario => {
                        const newId = generateId();
                        let name = scenario.name;

                        // Check for name conflicts and rename if necessary
                        const existingNames = Object.values(scenarios).map(s => s.name);
                        let counter = 1;
                        while (existingNames.includes(name)) {
                            counter++;
                            name = `${scenario.name} (${counter})`;
                        }

                        scenarios[newId] = {
                            ...scenario,
                            id: newId,
                            name
                        };
                        importCount++;
                    });

                    saveScenarios(scenarios);
                    updateScenarioDropdown();
                    showToast(`Imported ${importCount} scenario(s)`, 'success');
                } catch (error) {
                    showToast('Failed to import: Invalid file', 'error');
                }

                // Reset file input
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // Migrate from old format (single scenario) to new format
        function migrateFromOldFormat() {
            const scenarios = getScenarios();

            // If we already have scenarios, check for old data to migrate
            if (Object.keys(scenarios).length === 0) {
                const oldData = localStorage.getItem('firePlannerData');
                if (oldData) {
                    // Migrate old data
                    const data = JSON.parse(oldData);
                    createNewScenario('My First Scenario', data, true);
                    localStorage.removeItem('firePlannerData'); // Clean up old key
                } else {
                    // No data at all, create default scenario
                    createNewScenario('My First Scenario', null, true);
                }
            } else {
                // Load the last used scenario
                const savedCurrentId = localStorage.getItem(CURRENT_SCENARIO_KEY);
                if (savedCurrentId && scenarios[savedCurrentId]) {
                    loadScenario(savedCurrentId);
                } else {
                    // Load most recently modified
                    const sorted = Object.values(scenarios).sort((a, b) => b.lastModified - a.lastModified);
                    if (sorted.length > 0) {
                        loadScenario(sorted[0].id);
                    }
                }
                updateScenarioDropdown();
            }
        }

        // Close modals with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal('renameModal');
                closeModal('deleteModal');
            }
        });

        // Mark that there are unsaved changes
        function markUnsavedChanges() {
            if (isLoadingScenario) return; // Don't mark changes while loading
            if (!hasUnsavedChanges) {
                hasUnsavedChanges = true;
                updateUnsavedIndicator();
            }
        }

        // Clear unsaved changes flag
        function clearUnsavedChanges() {
            hasUnsavedChanges = false;
            updateUnsavedIndicator();
        }

        // Update the UI to show unsaved changes
        function updateUnsavedIndicator() {
            const saveBtn = document.getElementById('saveBtn');
            const indicator = document.getElementById('unsavedIndicator');

            if (hasUnsavedChanges) {
                saveBtn.classList.add('has-changes');
                indicator.style.display = 'inline';
            } else {
                saveBtn.classList.remove('has-changes');
                indicator.style.display = 'none';
            }
        }

        // Save button click handler
        function saveScenario() {
            saveCurrentScenario();
            clearUnsavedChanges();
            showToast('Scenario saved', 'success');
        }

        // Check for unsaved changes before switching scenarios
        function confirmSwitchScenario(newId) {
            if (hasUnsavedChanges) {
                if (!confirm('You have unsaved changes. Discard them and switch scenarios?')) {
                    // Reset dropdown to current scenario
                    document.getElementById('scenarioSelect').value = currentScenarioId;
                    return;
                }
            }
            clearUnsavedChanges();
            loadScenario(newId);
        }

        // Warn before leaving page with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
        // ========== END SCENARIO MANAGEMENT SYSTEM ==========

        // Currency formatting helpers
        function formatCurrency(value) {
            const num = parseFloat(value.toString().replace(/[^0-9.-]/g, ''));
            if (isNaN(num)) return '';
            return '$' + num.toLocaleString('en-US');
        }

        function parseCurrency(value) {
            return parseFloat(value.toString().replace(/[^0-9.-]/g, '')) || 0;
        }

        function adjustValue(id, amount) {
            const input = document.getElementById(id);
            const currentValue = parseCurrency(input.value);
            let newValue = Math.max(0, currentValue + amount);

            // Down payment can't exceed house price
            if (id === 'downPayment') {
                const housePrice = parseCurrency(document.getElementById('housePrice').value);
                newValue = Math.min(newValue, housePrice);
            }

            input.value = formatCurrency(newValue);
            markUnsavedChanges();
            calculate();
        }

        function adjustNum(id, amount) {
            const input = document.getElementById(id);
            const currentValue = parseFloat(input.value) || 0;
            let newValue = Math.max(0, currentValue + amount);

            // House age and retirement age can't be lower than current age
            if (id === 'houseAge' || id === 'retirementAge') {
                const currentAge = parseInt(document.getElementById('currentAge').value) || 0;
                newValue = Math.max(currentAge, newValue);
            }

            input.value = newValue;
            markUnsavedChanges();
            calculate();
        }

        function parsePercent(value) {
            return parseFloat(value.toString().replace(/[^0-9.-]/g, '')) || 0;
        }

        function formatPercent(value) {
            const num = parseFloat(value.toString().replace(/[^0-9.-]/g, ''));
            if (isNaN(num)) return '';
            return num + '%';
        }

        function adjustPercent(id, amount) {
            const input = document.getElementById(id);
            const currentValue = parsePercent(input.value);
            const newValue = Math.max(0, currentValue + amount);
            input.value = formatPercent(newValue);
            markUnsavedChanges();
            calculate();
        }

        function adjustYMax(direction) {
            const input = document.getElementById('yAxisMax');
            const currentValue = parseCurrency(input.value) || 500000;

            // Smart step based on current value
            let step;
            if (currentValue < 100000) step = 25000;
            else if (currentValue < 500000) step = 50000;
            else if (currentValue < 1000000) step = 100000;
            else if (currentValue < 5000000) step = 250000;
            else step = 500000;

            const newValue = Math.max(step, currentValue + (step * direction));
            input.value = formatCurrency(newValue);
            markUnsavedChanges();
            calculate();
        }

        function clearYMax() {
            document.getElementById('yAxisMax').value = '';
            markUnsavedChanges();
            calculate();
        }

        function adjustCashFlowYMax(direction) {
            const input = document.getElementById('cashFlowYMax');
            const currentValue = parseCurrency(input.value) || 100000;

            // Smart step based on current value
            let step;
            if (currentValue < 50000) step = 10000;
            else if (currentValue < 100000) step = 25000;
            else if (currentValue < 500000) step = 50000;
            else step = 100000;

            const newValue = Math.max(step, currentValue + (step * direction));
            input.value = formatCurrency(newValue);
            markUnsavedChanges();
            calculate();
        }

        function clearCashFlowYMax() {
            document.getElementById('cashFlowYMax').value = '';
            markUnsavedChanges();
            calculate();
        }

        function formatYMax() {
            const input = document.getElementById('yAxisMax');
            const val = parseCurrency(input.value);
            if (val > 0) input.value = formatCurrency(val);
        }

        // Hold-to-repeat functionality for +/- buttons
        let holdInterval = null;
        let holdTimeout = null;

        document.addEventListener('mousedown', (e) => {
            if (!e.target.classList.contains('inc-btn')) return;

            const btn = e.target;
            const onclick = btn.getAttribute('onclick');
            const func = () => eval(onclick);

            // Initial delay before repeating
            holdTimeout = setTimeout(() => {
                holdInterval = setInterval(func, 75);
            }, 400);
        });

        document.addEventListener('mouseup', clearHold);
        document.addEventListener('mouseleave', clearHold);

        function clearHold() {
            if (holdTimeout) { clearTimeout(holdTimeout); holdTimeout = null; }
            if (holdInterval) { clearInterval(holdInterval); holdInterval = null; }
        }

        function formatMoney(num) {
            if (num === 0) return '$0';
            return '$' + Math.round(num).toLocaleString('en-US');
        }

        function calculateMortgagePayment(principal, annualRate, years) {
            if (principal <= 0) return 0;
            const monthlyRate = annualRate / 100 / 12;
            const numPayments = years * 12;
            if (monthlyRate === 0) return principal / numPayments;
            return principal * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) /
                   (Math.pow(1 + monthlyRate, numPayments) - 1);
        }

        function calculate() {
            // Get inputs (use getValue for currency fields)
            const currentAge = parseInt(document.getElementById('currentAge').value) || 0;
            let retirementAge = parseInt(document.getElementById('retirementAge').value) || 0;

            // Retirement age can't be lower than current age
            if (retirementAge < currentAge) {
                retirementAge = currentAge;
                document.getElementById('retirementAge').value = retirementAge;
            }
            const initialBalance = parseCurrency(document.getElementById('initialBalance').value);
            const monthlySavings = parseCurrency(document.getElementById('monthlySavings').value);
            const annualReturn = parsePercent(document.getElementById('annualReturn').value) / 100 || 0;
            const monthlyWithdrawal = parseCurrency(document.getElementById('monthlyWithdrawal').value);
            let houseAge = parseInt(document.getElementById('houseAge').value) || 0;

            // House age can't be lower than current age
            if (houseAge < currentAge) {
                houseAge = currentAge;
                document.getElementById('houseAge').value = houseAge;
            }
            const housePrice = parseCurrency(document.getElementById('housePrice').value);
            let downPayment = parseCurrency(document.getElementById('downPayment').value);

            // Cap down payment at house price (silently for calculations, don't modify input while typing)
            if (downPayment > housePrice) {
                downPayment = housePrice;
            }
            const mortgageRate = parsePercent(document.getElementById('mortgageRate').value) || 0;
            const mortgageTerm = parseInt(document.getElementById('mortgageTerm').value) || 0;
            const socialSecurity = parseCurrency(document.getElementById('socialSecurity').value);
            const ssAge = parseInt(document.getElementById('ssAge').value) || 0;

            const currentYear = new Date().getFullYear();
            const endAge = 100;

            let data = [];
            let balance = initialBalance;
            let mortgageBalance = 0;
            let annualMortgage = 0;
            let actualMonthlyMortgage = 0;
            let mortgageStartYear = null;
            let peakBalance = 0;
            let peakAge = currentAge;
            let brokeAge = null;

            // If return is lower than mortgage rate, prioritize paying off mortgage
            const prioritizeMortgage = annualReturn < (mortgageRate / 100);

            for (let age = currentAge; age <= endAge; age++) {
                const year = currentYear + (age - currentAge);
                let phase = '';
                let cashIn = 0;
                let cashOut = 0;
                let mortgagePayment = 0;
                let extraPrincipal = 0;

                // Determine income status
                const isRetired = age >= retirementAge;
                const hasSS = age >= ssAge;

                // Determine housing status
                const hasHouse = age >= houseAge;
                const isBuyYear = age === houseAge;
                const hasMortgage = mortgageBalance > 0;

                // Handle house purchase
                if (isBuyYear) {
                    // Can only use what's available for down payment
                    const availableFunds = balance + (balance * annualReturn) + monthlySavings * 12;
                    const actualDownPayment = Math.min(downPayment, Math.max(0, availableFunds));
                    cashOut = actualDownPayment;
                    // Mortgage covers rest of house price
                    mortgageBalance = housePrice - actualDownPayment;
                    // Calculate mortgage payment based on actual loan amount
                    actualMonthlyMortgage = calculateMortgagePayment(mortgageBalance, mortgageRate, mortgageTerm);
                    annualMortgage = actualMonthlyMortgage * 12;
                    mortgageStartYear = year;
                }

                // Determine cash flows based on income status
                if (!isRetired) {
                    // Still working - saving phase
                    // Don't apply extra principal in buy year (already paying down payment)
                    if (!isBuyYear && prioritizeMortgage && mortgageBalance > 0) {
                        extraPrincipal = Math.min(monthlySavings * 12, mortgageBalance);
                        cashIn = (monthlySavings * 12) - extraPrincipal;
                    } else {
                        cashIn = monthlySavings * 12;
                    }
                } else {
                    // Retired - withdrawal phase
                    cashOut += monthlyWithdrawal * 12;
                    if (hasSS) {
                        cashIn = socialSecurity;
                    }
                }

                // Add mortgage payment if applicable
                if (hasHouse && mortgageBalance > 0) {
                    mortgagePayment = annualMortgage;
                }

                // Determine phase name
                let incomeStatus = !isRetired ? 'Save' : (hasSS ? 'Retire+SS' : 'Retire');
                let housingStatus = !hasHouse ? 'Rent' : (hasMortgage || isBuyYear ? 'Mortgage' : 'Own');
                phase = isBuyYear ? 'Buy House' : `${incomeStatus} / ${housingStatus}`;

                const startBalance = Math.max(0, balance);
                const gains = startBalance * annualReturn;

                // Calculate end balance
                balance = Math.max(0, startBalance + gains + cashIn - cashOut - mortgagePayment);

                // Update mortgage balance (only if payment was made)
                if (mortgagePayment > 0 || extraPrincipal > 0) {
                    const interestPaid = mortgageBalance * (mortgageRate / 100);
                    const principalPaid = mortgagePayment - interestPaid + extraPrincipal;
                    mortgageBalance = Math.max(0, mortgageBalance - principalPaid);
                }

                // Track peak
                if (balance > peakBalance) {
                    peakBalance = balance;
                    peakAge = age;
                }

                // Track if/when broke
                if (balance <= 0 && brokeAge === null) {
                    brokeAge = age;
                }

                data.push({
                    year,
                    age,
                    phase,
                    startBalance,
                    gains,
                    cashIn,
                    cashOut,
                    endBalance: Math.max(0, balance),
                    mortgagePayment: mortgagePayment + extraPrincipal,
                    mortgageBalance: Math.max(0, mortgageBalance)
                });
            }

            // Update summary cards
            const retireBalance = data.find(d => d.age === retirementAge)?.startBalance || 0;
            const ssStartBalance = data.find(d => d.age === ssAge)?.startBalance || 0;
            const finalBalance = data[data.length - 1].endBalance;

            document.getElementById('summaryCards').innerHTML = `
                <div class="summary-card">
                    <div class="label">Balance at Retirement (${retirementAge})</div>
                    <div class="value">${formatMoney(retireBalance)}</div>
                </div>
                <div class="summary-card">
                    <div class="label">Peak Balance</div>
                    <div class="value">${formatMoney(peakBalance)}</div>
                    <div class="sub">At age ${peakAge}</div>
                </div>
                <div class="summary-card">
                    <div class="label">Balance at SS Start (${ssAge})</div>
                    <div class="value">${formatMoney(ssStartBalance)}</div>
                </div>
                <div class="summary-card">
                    <div class="label">Monthly Mortgage</div>
                    <div class="value">${formatMoney(actualMonthlyMortgage)}</div>
                    <div class="sub">${mortgageTerm}-year @ ${mortgageRate}%</div>
                </div>
                <div class="summary-card">
                    <div class="label">Funds Last Until</div>
                    <div class="value ${brokeAge && brokeAge < 100 ? 'negative' : 'positive'}">${brokeAge ? 'Age ' + brokeAge : 'Age 100+'}</div>
                    ${brokeAge && brokeAge < 100 ? '<div class="sub negative">Consider adjustments</div>' : '<div class="sub positive">Looking good!</div>'}
                </div>
            `;

            // Update table
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = data.map(row => {
                let phaseClass = 'phase-save';
                if (row.phase.includes('Buy')) phaseClass = 'phase-buy';
                else if (row.phase.includes('Own')) phaseClass = 'phase-own';
                else if (row.phase.includes('Mortgage')) phaseClass = 'phase-mortgage';
                else if (row.phase.includes('SS')) phaseClass = 'phase-ss';
                else if (row.phase.includes('Retire')) phaseClass = 'phase-retire';

                return `
                    <tr>
                        <td>${row.year}</td>
                        <td>${row.age}</td>
                        <td class="${phaseClass}">${row.phase}</td>
                        <td>${formatMoney(row.startBalance)}</td>
                        <td>${formatMoney(row.gains)}</td>
                        <td>${formatMoney(row.cashIn)}</td>
                        <td>${formatMoney(row.cashOut)}</td>
                        <td>${formatMoney(row.endBalance)}</td>
                        <td>${formatMoney(row.mortgagePayment)}</td>
                        <td>${formatMoney(row.mortgageBalance)}</td>
                    </tr>
                `;
            }).join('');

            // Update charts
            updateCharts(data);
        }

        // Dark mode colors for Chart.js
        Chart.defaults.color = '#8b949e';
        Chart.defaults.borderColor = '#30363d';

        // Custom plugin for milestone vertical lines
        const milestonePlugin = {
            id: 'milestoneLines',
            afterDraw: (chart) => {
                const milestones = chart.options.plugins.milestoneLines?.milestones;
                if (!milestones || !milestones.length) return;

                const ctx = chart.ctx;
                const xAxis = chart.scales.x;
                const yAxis = chart.scales.y;
                const labels = chart.data.labels;

                milestones.forEach(m => {
                    // Find the index of this age in the labels
                    const index = labels.indexOf(m.age);
                    if (index === -1) return;

                    const xPos = xAxis.getPixelForValue(index);
                    if (xPos < xAxis.left || xPos > xAxis.right) return;

                    // Draw vertical line
                    ctx.save();
                    ctx.beginPath();
                    ctx.setLineDash([4, 4]);
                    ctx.strokeStyle = m.color || '#8b949e';
                    ctx.lineWidth = 1.5;
                    ctx.moveTo(xPos, yAxis.top);
                    ctx.lineTo(xPos, yAxis.bottom);
                    ctx.stroke();

                    // Draw label to the right of the line
                    ctx.fillStyle = m.color || '#8b949e';
                    ctx.font = '10px -apple-system, BlinkMacSystemFont, sans-serif';
                    ctx.textAlign = 'left';
                    ctx.fillText(m.label, xPos + 4, yAxis.top + 12);
                    ctx.restore();
                });
            }
        };
        Chart.register(milestonePlugin);

        // Get current milestones for charts
        function getMilestones() {
            const currentAge = parseInt(document.getElementById('currentAge').value) || 0;
            const houseAge = parseInt(document.getElementById('houseAge').value) || 0;
            const retirementAge = parseInt(document.getElementById('retirementAge').value) || 0;
            const ssAge = parseInt(document.getElementById('ssAge').value) || 0;

            const milestones = [];
            if (houseAge >= currentAge) {
                milestones.push({ age: houseAge, label: 'Buy House', color: '#d29922' });
            }
            if (retirementAge >= currentAge) {
                milestones.push({ age: retirementAge, label: 'Retire', color: '#3fb950' });
            }
            if (ssAge >= currentAge && ssAge !== retirementAge) {
                milestones.push({ age: ssAge, label: 'SS Start', color: '#39d353' });
            }
            return milestones;
        }

        function createChartOptions(showLegend = true) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    milestoneLines: {
                        milestones: getMilestones()
                    },
                    legend: {
                        display: showLegend,
                        position: 'top',
                        labels: {
                            boxWidth: 12,
                            font: { size: 11 },
                            padding: 8,
                            color: '#e6edf3'
                        }
                    },
                    tooltip: {
                        backgroundColor: '#21262d',
                        titleColor: '#e6edf3',
                        bodyColor: '#e6edf3',
                        borderColor: '#30363d',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': $' +
                                       Math.round(context.raw).toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Age', color: '#8b949e' },
                        ticks: { maxTicksLimit: 15, color: '#8b949e' },
                        grid: { color: '#21262d' }
                    },
                    y: {
                        ticks: {
                            color: '#8b949e',
                            callback: function(value) {
                                const absValue = Math.abs(value);
                                const sign = value < 0 ? '-' : '';
                                if (absValue >= 1000000) return sign + '$' + (absValue/1000000).toFixed(1) + 'M';
                                if (absValue >= 1000) return sign + '$' + (absValue/1000).toFixed(0) + 'K';
                                return sign + '$' + absValue;
                            }
                        },
                        grid: { color: '#21262d' }
                    }
                }
            };
        }

        function updateCharts(data) {
            const labels = data.map(d => d.age);

            // If charts exist, just update the data (smooth transition)
            if (balanceChart && cashFlowChart && mortgageChart) {
                // Update Balance Chart
                balanceChart.data.labels = labels;
                balanceChart.data.datasets[0].data = data.map(d => d.startBalance);
                balanceChart.data.datasets[1].data = data.map(d => d.endBalance);
                const yMaxInput = document.getElementById('yAxisMax').value;
                const yMaxValue = parseCurrency(yMaxInput);
                // Use minimum of set max and data max (so chart doesn't waste space)
                const dataMax = Math.max(...data.map(d => Math.max(d.startBalance, d.endBalance)));
                balanceChart.options.scales.y.max = yMaxValue > 0 ? Math.min(yMaxValue, dataMax * 1.1) : undefined;
                // Update milestones
                const milestones = getMilestones();
                balanceChart.options.plugins.milestoneLines.milestones = milestones;
                cashFlowChart.options.plugins.milestoneLines.milestones = milestones;
                mortgageChart.options.plugins.milestoneLines.milestones = milestones;
                balanceChart.update('none'); // 'none' for instant, remove for animation

                // Update Cash Flow Chart
                cashFlowChart.data.labels = labels;
                cashFlowChart.data.datasets[0].data = data.map(d => d.cashIn);
                cashFlowChart.data.datasets[1].data = data.map(d => d.cashOut);
                cashFlowChart.data.datasets[2].data = data.map(d => d.gains + d.cashIn - d.cashOut - d.mortgagePayment);
                cashFlowChart.data.datasets[3].data = data.map(d => d.gains);
                const cfYMaxInput = document.getElementById('cashFlowYMax').value;
                const cfYMaxValue = parseCurrency(cfYMaxInput);
                const cfDataMax = Math.max(...data.map(d => Math.max(d.cashIn, d.cashOut, d.gains, Math.abs(d.gains + d.cashIn - d.cashOut - d.mortgagePayment))));
                cashFlowChart.options.scales.y.max = cfYMaxValue > 0 ? Math.min(cfYMaxValue, cfDataMax * 1.1) : undefined;
                cashFlowChart.update('none');

                // Update Mortgage Chart
                mortgageChart.data.labels = labels;
                mortgageChart.data.datasets[0].data = data.map(d => d.mortgageBalance);
                mortgageChart.data.datasets[1].data = data.map(d => d.mortgagePayment);
                mortgageChart.update('none');
                return;
            }

            // Chart 1: Portfolio Balance (Y-axis starts at 0)
            const balanceOptions = createChartOptions();
            balanceOptions.scales.y.min = 0;
            const yMaxInput = document.getElementById('yAxisMax').value;
            const yMaxValue = parseCurrency(yMaxInput);
            // Use minimum of set max and data max (so chart doesn't waste space)
            const dataMax = Math.max(...data.map(d => Math.max(d.startBalance, d.endBalance)));
            if (yMaxValue > 0) {
                balanceOptions.scales.y.max = Math.min(yMaxValue, dataMax * 1.1);
            }

            balanceChart = new Chart(document.getElementById('balanceChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Start Balance',
                            data: data.map(d => d.startBalance),
                            borderColor: '#58a6ff',
                            backgroundColor: 'rgba(88, 166, 255, 0.15)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'End Balance',
                            data: data.map(d => d.endBalance),
                            borderColor: '#f0883e',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: balanceOptions
            });

            // Chart 2: Cash Flows
            const cashFlowOptions = createChartOptions();
            const cfYMaxInput = document.getElementById('cashFlowYMax').value;
            const cfYMaxValue = parseCurrency(cfYMaxInput);
            const cfDataMax = Math.max(...data.map(d => Math.max(d.cashIn, d.cashOut, d.gains, Math.abs(d.gains + d.cashIn - d.cashOut - d.mortgagePayment))));
            if (cfYMaxValue > 0) {
                cashFlowOptions.scales.y.max = Math.min(cfYMaxValue, cfDataMax * 1.1);
            }

            cashFlowChart = new Chart(document.getElementById('cashFlowChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Cash In',
                            data: data.map(d => d.cashIn),
                            borderColor: '#3fb950',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Cash Out',
                            data: data.map(d => d.cashOut),
                            borderColor: '#f85149',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Net Change',
                            data: data.map(d => d.gains + d.cashIn - d.cashOut - d.mortgagePayment),
                            borderColor: '#8b949e',
                            backgroundColor: 'rgba(248, 81, 73, 0.25)',
                            borderWidth: 2,
                            fill: {
                                target: 'origin',
                                above: 'rgba(63, 185, 80, 0.15)',
                                below: 'rgba(248, 81, 73, 0.25)'
                            },
                            tension: 0.1
                        },
                        {
                            label: 'Gains',
                            data: data.map(d => d.gains),
                            borderColor: '#a371f7',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: cashFlowOptions
            });

            // Chart 3: Mortgage
            mortgageChart = new Chart(document.getElementById('mortgageChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Mortgage Balance',
                            data: data.map(d => d.mortgageBalance),
                            borderColor: '#79c0ff',
                            backgroundColor: 'rgba(121, 192, 255, 0.15)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'Annual Payment',
                            data: data.map(d => d.mortgagePayment),
                            borderColor: '#56d4dd',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: createChartOptions()
            });
        }

        // Currency input formatting
        currencyInputs.forEach(id => {
            const input = document.getElementById(id);
            if (!input) return;

            // Format on load
            input.value = formatCurrency(input.value);

            // Select all on focus for easy editing
            input.addEventListener('focus', function() {
                this.select();
            });

            // Format on blur
            input.addEventListener('blur', function() {
                this.value = formatCurrency(this.value);
            });

            // Allow typing and trigger calculation
            input.addEventListener('input', function() {
                calculate();
            });
        });

        // Initialize scenario system (migrate from old format if needed)
        migrateFromOldFormat();

        // Format currency inputs after loading
        currencyInputs.forEach(id => {
            const input = document.getElementById(id);
            if (input) input.value = formatCurrency(input.value);
        });

        // Track unsaved changes (removed auto-save for manual control)
        document.addEventListener('input', (e) => {
            // Ignore scenario dropdown changes
            if (e.target.id === 'scenarioSelect') return;
            markUnsavedChanges();
        });

        // Run on page load
        calculate();

        // Real-time updates on input change (for non-currency inputs)
        document.querySelectorAll('input').forEach(input => {
            if (!currencyInputs.includes(input.id)) {
                input.addEventListener('input', calculate);
            }
        });

        // Y-axis max input
        const yMaxInput = document.getElementById('yAxisMax');
        yMaxInput.addEventListener('input', calculate);
        yMaxInput.addEventListener('focus', function() { this.select(); });
        yMaxInput.addEventListener('blur', formatYMax);
        formatYMax(); // Format on load

        // Cash flow Y-axis max input
        const cfYMaxInput = document.getElementById('cashFlowYMax');
        cfYMaxInput.addEventListener('input', calculate);
        cfYMaxInput.addEventListener('focus', function() { this.select(); });
        cfYMaxInput.addEventListener('blur', function() {
            const val = parseCurrency(this.value);
            if (val > 0) this.value = formatCurrency(val);
        });
        // Format on load
        const cfVal = parseCurrency(cfYMaxInput.value);
        if (cfVal > 0) cfYMaxInput.value = formatCurrency(cfVal);

        // Percent input formatting
        const percentInputs = ['annualReturn', 'mortgageRate'];
        percentInputs.forEach(id => {
            const input = document.getElementById(id);
            if (!input) return;
            input.addEventListener('focus', function() { this.select(); });
            input.addEventListener('blur', function() { this.value = formatPercent(this.value); });
            input.addEventListener('input', calculate);
        });

        // Clear any false positives from initialization
        clearUnsavedChanges();
    </script>
</body>
</html>
