<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIRE Financial Planner</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #e6edf3;
            line-height: 1.5;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #58a6ff;
            margin-bottom: 24px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .top-section {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        @media (max-width: 900px) {
            .top-section {
                grid-template-columns: 1fr;
            }
        }
        .inputs-panel {
            background: #161b22;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #30363d;
        }
        .inputs-panel h2 {
            font-size: 16px;
            color: #58a6ff;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #238636;
        }
        .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .input-row label {
            font-size: 14px;
            color: #8b949e;
        }
        .input-row input {
            width: 110px;
            padding: 6px 8px;
            border: 1px solid #30363d;
            border-radius: 4px;
            font-size: 14px;
            text-align: right;
            background: #0d1117;
            color: #e6edf3;
        }
        .input-row input:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2);
        }
        .input-with-buttons {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .input-with-buttons input {
            width: 88px;
        }
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .inc-btn {
            width: 22px;
            height: 13px;
            padding: 0;
            margin: 0;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 3px;
            color: #8b949e;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .inc-btn:hover {
            background: #30363d;
            color: #e6edf3;
        }
        .inc-btn:active {
            background: #238636;
        }
        .input-section {
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #30363d;
        }
        .input-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .input-section-title {
            font-size: 12px;
            font-weight: 600;
            color: #8b949e;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .chart-panel {
            background: #161b22;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #30363d;
        }
        .chart-container {
            position: relative;
            height: 220px;
        }
        .charts-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .chart-panel h3 {
            font-size: 14px;
            color: #8b949e;
            margin-bottom: 12px;
        }
        .table-section {
            background: #161b22;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #30363d;
            overflow-x: auto;
        }
        .table-section h2 {
            font-size: 16px;
            color: #58a6ff;
            margin-bottom: 16px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th, td {
            padding: 8px 12px;
            text-align: right;
            border-bottom: 1px solid #30363d;
            white-space: nowrap;
        }
        th {
            background: #21262d;
            font-weight: 600;
            color: #8b949e;
            position: sticky;
            top: 0;
        }
        th:first-child, td:first-child,
        th:nth-child(2), td:nth-child(2),
        th:nth-child(3), td:nth-child(3) {
            text-align: left;
        }
        tr:hover {
            background: #1f2937;
        }
        .phase-save { color: #58a6ff; }
        .phase-buy { color: #d29922; }
        .phase-mortgage { color: #a371f7; }
        .phase-retire { color: #3fb950; }
        .phase-ss { color: #39d353; }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .summary-card {
            background: #161b22;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #30363d;
        }
        .summary-card .label {
            font-size: 12px;
            color: #8b949e;
            text-transform: uppercase;
        }
        .summary-card .value {
            font-size: 24px;
            font-weight: 600;
            color: #58a6ff;
        }
        .summary-card .sub {
            font-size: 12px;
            color: #8b949e;
        }
        .negative { color: #f85149; }
        .positive { color: #3fb950; }
    </style>
</head>
<body>
    <div class="container">
        <h1>FIRE Financial Planner</h1>

        <div class="summary-cards" id="summaryCards"></div>

        <div class="top-section">
            <div class="inputs-panel">
                <h2>Inputs</h2>

                <div class="input-section">
                    <div class="input-section-title">Personal</div>
                    <div class="input-row">
                        <label>Current Age</label>
                        <div class="input-with-buttons">
                            <input type="number" id="currentAge" value="35">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustNum('currentAge', 1)">+</button>
                                <button class="inc-btn" onclick="adjustNum('currentAge', -1)">−</button>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <label>Retirement Age</label>
                        <div class="input-with-buttons">
                            <input type="number" id="retirementAge" value="42">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustNum('retirementAge', 1)">+</button>
                                <button class="inc-btn" onclick="adjustNum('retirementAge', -1)">−</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="input-section">
                    <div class="input-section-title">Savings & Returns</div>
                    <div class="input-row">
                        <label>Initial Balance</label>
                        <div class="input-with-buttons">
                            <input type="text" id="initialBalance" value="235000">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustValue('initialBalance', 1000)">+</button>
                                <button class="inc-btn" onclick="adjustValue('initialBalance', -1000)">−</button>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <label>Monthly Savings</label>
                        <div class="input-with-buttons">
                            <input type="text" id="monthlySavings" value="7000">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustValue('monthlySavings', 500)">+</button>
                                <button class="inc-btn" onclick="adjustValue('monthlySavings', -500)">−</button>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <label>Annual Return (%)</label>
                        <div class="input-with-buttons">
                            <input type="number" id="annualReturn" value="5" step="0.5">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustNum('annualReturn', 0.5)">+</button>
                                <button class="inc-btn" onclick="adjustNum('annualReturn', -0.5)">−</button>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <label>Monthly Withdrawal</label>
                        <div class="input-with-buttons">
                            <input type="text" id="monthlyWithdrawal" value="4000">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustValue('monthlyWithdrawal', 500)">+</button>
                                <button class="inc-btn" onclick="adjustValue('monthlyWithdrawal', -500)">−</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="input-section">
                    <div class="input-section-title">Home Purchase</div>
                    <div class="input-row">
                        <label>House Purchase Age</label>
                        <div class="input-with-buttons">
                            <input type="number" id="houseAge" value="36">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustNum('houseAge', 1)">+</button>
                                <button class="inc-btn" onclick="adjustNum('houseAge', -1)">−</button>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <label>House Price</label>
                        <div class="input-with-buttons">
                            <input type="text" id="housePrice" value="190000">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustValue('housePrice', 1000)">+</button>
                                <button class="inc-btn" onclick="adjustValue('housePrice', -1000)">−</button>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <label>Down Payment</label>
                        <div class="input-with-buttons">
                            <input type="text" id="downPayment" value="150000">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustValue('downPayment', 1000)">+</button>
                                <button class="inc-btn" onclick="adjustValue('downPayment', -1000)">−</button>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <label>Mortgage Rate (%)</label>
                        <div class="input-with-buttons">
                            <input type="number" id="mortgageRate" value="6" step="0.125">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustNum('mortgageRate', 0.25)">+</button>
                                <button class="inc-btn" onclick="adjustNum('mortgageRate', -0.25)">−</button>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <label>Mortgage Term (yrs)</label>
                        <div class="input-with-buttons">
                            <input type="number" id="mortgageTerm" value="15">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustNum('mortgageTerm', 5)">+</button>
                                <button class="inc-btn" onclick="adjustNum('mortgageTerm', -5)">−</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="input-section">
                    <div class="input-section-title">Social Security</div>
                    <div class="input-row">
                        <label>Annual SS Benefit</label>
                        <div class="input-with-buttons">
                            <input type="text" id="socialSecurity" value="24000">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustValue('socialSecurity', 1000)">+</button>
                                <button class="inc-btn" onclick="adjustValue('socialSecurity', -1000)">−</button>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <label>SS Start Age</label>
                        <div class="input-with-buttons">
                            <input type="number" id="ssAge" value="62">
                            <div class="btn-group">
                                <button class="inc-btn" onclick="adjustNum('ssAge', 1)">+</button>
                                <button class="inc-btn" onclick="adjustNum('ssAge', -1)">−</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-panel">
                    <h3>Portfolio Balance</h3>
                    <div class="chart-container">
                        <canvas id="balanceChart"></canvas>
                    </div>
                </div>
                <div class="chart-panel">
                    <h3>Annual Cash Flows</h3>
                    <div class="chart-container">
                        <canvas id="cashFlowChart"></canvas>
                    </div>
                </div>
                <div class="chart-panel">
                    <h3>Mortgage</h3>
                    <div class="chart-container">
                        <canvas id="mortgageChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-section">
            <h2>Year-by-Year Projection</h2>
            <div style="max-height: 500px; overflow-y: auto;">
                <table id="projectionTable">
                    <thead>
                        <tr>
                            <th>Year</th>
                            <th>Age</th>
                            <th>Phase</th>
                            <th>Start Balance</th>
                            <th>Gains</th>
                            <th>Cash In</th>
                            <th>Cash Out</th>
                            <th>End Balance</th>
                            <th>Mortgage Pmt</th>
                            <th>Mortgage Bal</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let balanceChart = null;
        let cashFlowChart = null;
        let mortgageChart = null;

        // Currency formatting helpers
        function formatCurrency(value) {
            const num = parseFloat(value.toString().replace(/[^0-9.-]/g, ''));
            if (isNaN(num)) return '';
            return '$' + num.toLocaleString('en-US');
        }

        function parseCurrency(value) {
            return parseFloat(value.toString().replace(/[^0-9.-]/g, '')) || 0;
        }

        function adjustValue(id, amount) {
            const input = document.getElementById(id);
            const currentValue = parseCurrency(input.value);
            const newValue = Math.max(0, currentValue + amount);
            input.value = formatCurrency(newValue);
            calculate();
        }

        function adjustNum(id, amount) {
            const input = document.getElementById(id);
            const currentValue = parseFloat(input.value) || 0;
            const newValue = Math.max(0, currentValue + amount);
            input.value = newValue;
            calculate();
        }

        // Hold-to-repeat functionality for +/- buttons
        let holdInterval = null;
        let holdTimeout = null;

        document.addEventListener('mousedown', (e) => {
            if (!e.target.classList.contains('inc-btn')) return;

            const btn = e.target;
            const onclick = btn.getAttribute('onclick');
            const func = () => eval(onclick);

            // Initial delay before repeating
            holdTimeout = setTimeout(() => {
                holdInterval = setInterval(func, 75);
            }, 400);
        });

        document.addEventListener('mouseup', clearHold);
        document.addEventListener('mouseleave', clearHold);

        function clearHold() {
            if (holdTimeout) { clearTimeout(holdTimeout); holdTimeout = null; }
            if (holdInterval) { clearInterval(holdInterval); holdInterval = null; }
        }

        function formatMoney(num) {
            if (num === 0) return '$0';
            return '$' + Math.round(num).toLocaleString('en-US');
        }

        function calculateMortgagePayment(principal, annualRate, years) {
            if (principal <= 0) return 0;
            const monthlyRate = annualRate / 100 / 12;
            const numPayments = years * 12;
            if (monthlyRate === 0) return principal / numPayments;
            return principal * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) /
                   (Math.pow(1 + monthlyRate, numPayments) - 1);
        }

        function calculate() {
            // Get inputs (use getValue for currency fields)
            const currentAge = parseInt(document.getElementById('currentAge').value) || 0;
            const retirementAge = parseInt(document.getElementById('retirementAge').value) || 0;
            const initialBalance = parseCurrency(document.getElementById('initialBalance').value);
            const monthlySavings = parseCurrency(document.getElementById('monthlySavings').value);
            const annualReturn = parseFloat(document.getElementById('annualReturn').value) / 100 || 0;
            const monthlyWithdrawal = parseCurrency(document.getElementById('monthlyWithdrawal').value);
            const houseAge = parseInt(document.getElementById('houseAge').value) || 0;
            const housePrice = parseCurrency(document.getElementById('housePrice').value);
            const downPayment = parseCurrency(document.getElementById('downPayment').value);
            const mortgageRate = parseFloat(document.getElementById('mortgageRate').value) || 0;
            const mortgageTerm = parseInt(document.getElementById('mortgageTerm').value) || 0;
            const socialSecurity = parseCurrency(document.getElementById('socialSecurity').value);
            const ssAge = parseInt(document.getElementById('ssAge').value) || 0;

            const currentYear = new Date().getFullYear();
            const endAge = 100;
            const loanAmount = housePrice - downPayment;
            const monthlyMortgage = calculateMortgagePayment(loanAmount, mortgageRate, mortgageTerm);
            const annualMortgage = monthlyMortgage * 12;

            let data = [];
            let balance = initialBalance;
            let mortgageBalance = 0;
            let mortgageStartYear = null;
            let peakBalance = 0;
            let peakAge = currentAge;
            let brokeAge = null;

            for (let age = currentAge; age <= endAge; age++) {
                const year = currentYear + (age - currentAge);
                let phase = '';
                let cashIn = 0;
                let cashOut = 0;
                let mortgagePayment = 0;

                // Determine phase and cash flows
                if (age < houseAge) {
                    phase = 'Save / Rent';
                    cashIn = monthlySavings * 12;
                } else if (age === houseAge) {
                    phase = 'Buy House';
                    cashIn = monthlySavings * 12;
                    cashOut = downPayment;
                    mortgageBalance = loanAmount;
                    mortgageStartYear = year;
                } else if (age < retirementAge) {
                    phase = 'Save/Mortgage';
                    cashIn = monthlySavings * 12;
                    if (mortgageBalance > 0) {
                        mortgagePayment = annualMortgage;
                    }
                } else if (age >= ssAge) {
                    phase = 'Retire + SS';
                    cashIn = socialSecurity;
                    cashOut = monthlyWithdrawal * 12;
                    if (mortgageBalance > 0) {
                        mortgagePayment = annualMortgage;
                    }
                } else {
                    phase = 'Retire';
                    cashOut = monthlyWithdrawal * 12;
                    if (mortgageBalance > 0) {
                        mortgagePayment = annualMortgage;
                    }
                }

                const startBalance = balance;
                const gains = startBalance * annualReturn;

                // Calculate end balance
                balance = startBalance + gains + cashIn - cashOut - mortgagePayment;

                // Update mortgage balance
                if (mortgageBalance > 0) {
                    const interestPaid = mortgageBalance * (mortgageRate / 100);
                    const principalPaid = annualMortgage - interestPaid;
                    mortgageBalance = Math.max(0, mortgageBalance - principalPaid);
                }

                // Track peak
                if (balance > peakBalance) {
                    peakBalance = balance;
                    peakAge = age;
                }

                // Track if/when broke
                if (balance <= 0 && brokeAge === null) {
                    brokeAge = age;
                }

                data.push({
                    year,
                    age,
                    phase,
                    startBalance,
                    gains,
                    cashIn,
                    cashOut,
                    endBalance: Math.max(0, balance),
                    mortgagePayment,
                    mortgageBalance: Math.max(0, mortgageBalance)
                });
            }

            // Update summary cards
            const retireBalance = data.find(d => d.age === retirementAge)?.startBalance || 0;
            const ssStartBalance = data.find(d => d.age === ssAge)?.startBalance || 0;
            const finalBalance = data[data.length - 1].endBalance;

            document.getElementById('summaryCards').innerHTML = `
                <div class="summary-card">
                    <div class="label">Balance at Retirement (${retirementAge})</div>
                    <div class="value">${formatMoney(retireBalance)}</div>
                </div>
                <div class="summary-card">
                    <div class="label">Peak Balance</div>
                    <div class="value">${formatMoney(peakBalance)}</div>
                    <div class="sub">At age ${peakAge}</div>
                </div>
                <div class="summary-card">
                    <div class="label">Balance at SS Start (${ssAge})</div>
                    <div class="value">${formatMoney(ssStartBalance)}</div>
                </div>
                <div class="summary-card">
                    <div class="label">Monthly Mortgage</div>
                    <div class="value">${formatMoney(monthlyMortgage)}</div>
                    <div class="sub">${mortgageTerm}-year @ ${mortgageRate}%</div>
                </div>
                <div class="summary-card">
                    <div class="label">Funds Last Until</div>
                    <div class="value ${brokeAge && brokeAge < 100 ? 'negative' : 'positive'}">${brokeAge ? 'Age ' + brokeAge : 'Age 100+'}</div>
                    ${brokeAge && brokeAge < 100 ? '<div class="sub negative">Consider adjustments</div>' : '<div class="sub positive">Looking good!</div>'}
                </div>
            `;

            // Update table
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = data.map(row => {
                let phaseClass = 'phase-save';
                if (row.phase.includes('Buy')) phaseClass = 'phase-buy';
                else if (row.phase.includes('Mortgage')) phaseClass = 'phase-mortgage';
                else if (row.phase.includes('SS')) phaseClass = 'phase-ss';
                else if (row.phase.includes('Retire')) phaseClass = 'phase-retire';

                return `
                    <tr>
                        <td>${row.year}</td>
                        <td>${row.age}</td>
                        <td class="${phaseClass}">${row.phase}</td>
                        <td>${formatMoney(row.startBalance)}</td>
                        <td>${formatMoney(row.gains)}</td>
                        <td>${formatMoney(row.cashIn)}</td>
                        <td>${formatMoney(row.cashOut)}</td>
                        <td>${formatMoney(row.endBalance)}</td>
                        <td>${formatMoney(row.mortgagePayment)}</td>
                        <td>${formatMoney(row.mortgageBalance)}</td>
                    </tr>
                `;
            }).join('');

            // Update charts
            updateCharts(data);
        }

        // Dark mode colors for Chart.js
        Chart.defaults.color = '#8b949e';
        Chart.defaults.borderColor = '#30363d';

        function createChartOptions(showLegend = true) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: showLegend,
                        position: 'top',
                        labels: {
                            boxWidth: 12,
                            font: { size: 11 },
                            padding: 8,
                            color: '#e6edf3'
                        }
                    },
                    tooltip: {
                        backgroundColor: '#21262d',
                        titleColor: '#e6edf3',
                        bodyColor: '#e6edf3',
                        borderColor: '#30363d',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': $' +
                                       Math.round(context.raw).toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Age', color: '#8b949e' },
                        ticks: { maxTicksLimit: 15, color: '#8b949e' },
                        grid: { color: '#21262d' }
                    },
                    y: {
                        ticks: {
                            color: '#8b949e',
                            callback: function(value) {
                                if (value >= 1000000) return '$' + (value/1000000).toFixed(1) + 'M';
                                if (value >= 1000) return '$' + (value/1000).toFixed(0) + 'K';
                                return '$' + value;
                            }
                        },
                        grid: { color: '#21262d' }
                    }
                }
            };
        }

        function updateCharts(data) {
            const labels = data.map(d => d.age);

            // If charts exist, just update the data (smooth transition)
            if (balanceChart && cashFlowChart && mortgageChart) {
                // Update Balance Chart
                balanceChart.data.labels = labels;
                balanceChart.data.datasets[0].data = data.map(d => d.startBalance);
                balanceChart.data.datasets[1].data = data.map(d => d.endBalance);
                balanceChart.update('none'); // 'none' for instant, remove for animation

                // Update Cash Flow Chart
                cashFlowChart.data.labels = labels;
                cashFlowChart.data.datasets[0].data = data.map(d => d.cashIn);
                cashFlowChart.data.datasets[1].data = data.map(d => d.cashOut);
                cashFlowChart.data.datasets[2].data = data.map(d => d.gains);
                cashFlowChart.update('none');

                // Update Mortgage Chart
                mortgageChart.data.labels = labels;
                mortgageChart.data.datasets[0].data = data.map(d => d.mortgageBalance);
                mortgageChart.data.datasets[1].data = data.map(d => d.mortgagePayment);
                mortgageChart.update('none');
                return;
            }

            // Chart 1: Portfolio Balance (Y-axis starts at 0)
            const balanceOptions = createChartOptions();
            balanceOptions.scales.y.min = 0;

            balanceChart = new Chart(document.getElementById('balanceChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Start Balance',
                            data: data.map(d => d.startBalance),
                            borderColor: '#58a6ff',
                            backgroundColor: 'rgba(88, 166, 255, 0.15)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'End Balance',
                            data: data.map(d => d.endBalance),
                            borderColor: '#f0883e',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: balanceOptions
            });

            // Chart 2: Cash Flows
            cashFlowChart = new Chart(document.getElementById('cashFlowChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Cash In',
                            data: data.map(d => d.cashIn),
                            borderColor: '#3fb950',
                            backgroundColor: 'rgba(63, 185, 80, 0.15)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'Cash Out',
                            data: data.map(d => d.cashOut),
                            borderColor: '#f85149',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Gains',
                            data: data.map(d => d.gains),
                            borderColor: '#a371f7',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: createChartOptions()
            });

            // Chart 3: Mortgage
            mortgageChart = new Chart(document.getElementById('mortgageChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Mortgage Balance',
                            data: data.map(d => d.mortgageBalance),
                            borderColor: '#79c0ff',
                            backgroundColor: 'rgba(121, 192, 255, 0.15)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'Annual Payment',
                            data: data.map(d => d.mortgagePayment),
                            borderColor: '#56d4dd',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: createChartOptions()
            });
        }

        // Currency input formatting
        const currencyInputs = [
            'initialBalance', 'monthlySavings', 'monthlyWithdrawal',
            'housePrice', 'downPayment', 'socialSecurity'
        ];

        currencyInputs.forEach(id => {
            const input = document.getElementById(id);
            if (!input) return;

            // Format on load
            input.value = formatCurrency(input.value);

            // Select all on focus for easy editing
            input.addEventListener('focus', function() {
                this.select();
            });

            // Format on blur
            input.addEventListener('blur', function() {
                this.value = formatCurrency(this.value);
            });

            // Allow typing and trigger calculation
            input.addEventListener('input', function() {
                calculate();
            });
        });

        // Run on page load
        calculate();

        // Real-time updates on input change (for non-currency inputs)
        document.querySelectorAll('input').forEach(input => {
            if (!currencyInputs.includes(input.id)) {
                input.addEventListener('input', calculate);
            }
        });
    </script>
</body>
</html>
