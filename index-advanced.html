<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIRE Planner Advanced</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #e6edf3;
            line-height: 1.5;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #58a6ff;
            margin-bottom: 24px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        .top-section {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        @media (max-width: 1100px) {
            .top-section {
                grid-template-columns: 1fr;
            }
        }
        .inputs-panel {
            background: #161b22;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #30363d;
            max-height: 900px;
            overflow-y: auto;
        }
        .inputs-panel::-webkit-scrollbar {
            width: 8px;
        }
        .inputs-panel::-webkit-scrollbar-track {
            background: #161b22;
        }
        .inputs-panel::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }
        .inputs-panel::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }
        .inputs-panel {
            scrollbar-width: thin;
            scrollbar-color: #30363d #161b22;
        }
        .inputs-panel h2 {
            font-size: 16px;
            color: #58a6ff;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #238636;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .inputs-panel h2:hover {
            color: #79c0ff;
        }
        .inputs-panel h2::after {
            content: 'â–¼';
            font-size: 10px;
            transition: transform 0.2s;
        }
        .inputs-panel h2.collapsed::after {
            transform: rotate(-90deg);
        }
        .input-section {
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #30363d;
        }
        .input-section.collapsed .section-content {
            display: none;
        }
        .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .input-row label {
            font-size: 14px;
            color: #8b949e;
        }
        .input-row input, .input-row select {
            width: 120px;
            padding: 6px 8px;
            border: 1px solid #30363d;
            border-radius: 4px;
            font-size: 14px;
            text-align: right;
            background: #0d1117;
            color: #e6edf3;
            -moz-appearance: textfield;
        }
        .input-row select {
            text-align: left;
        }
        .input-row input::-webkit-outer-spin-button,
        .input-row input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .input-row input:focus, .input-row select:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2);
        }
        .input-with-buttons {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .input-with-buttons input {
            width: 98px;
        }
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .inc-btn {
            width: 22px;
            height: 13px;
            padding: 0;
            margin: 0;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 3px;
            color: #8b949e;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .inc-btn:hover {
            background: #30363d;
            color: #e6edf3;
        }
        .inc-btn:active {
            background: #238636;
        }

        /* Account and Asset Cards */
        .item-list {
            margin-top: 10px;
        }
        .item-card {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .item-card:hover {
            border-color: #58a6ff;
        }
        .item-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .item-card-title {
            font-weight: 600;
            color: #58a6ff;
            font-size: 14px;
        }
        .item-card-value {
            font-size: 16px;
            font-weight: 600;
            color: #7ee787;
        }
        .item-card-details {
            font-size: 12px;
            color: #8b949e;
        }
        .item-card-row {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
        }
        .delete-btn {
            background: transparent;
            border: none;
            color: #f85149;
            cursor: pointer;
            font-size: 16px;
            padding: 2px 6px;
        }
        .delete-btn:hover {
            background: rgba(248, 81, 73, 0.2);
            border-radius: 4px;
        }
        .add-btn {
            width: 100%;
            padding: 10px;
            background: #21262d;
            border: 1px dashed #30363d;
            border-radius: 6px;
            color: #58a6ff;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        .add-btn:hover {
            background: #30363d;
            border-color: #58a6ff;
        }

        /* Event Timeline */
        .event-timeline {
            margin-top: 10px;
            position: relative;
            padding-left: 20px;
        }
        .event-timeline::before {
            content: '';
            position: absolute;
            left: 6px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #30363d;
        }
        .event-item {
            position: relative;
            padding: 8px 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .event-item::before {
            content: '';
            position: absolute;
            left: -17px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #238636;
            border: 2px solid #0d1117;
        }
        .event-item.career::before { background: #58a6ff; }
        .event-item.accounts::before { background: #a371f7; }
        .event-item.realestate::before { background: #f0883e; }
        .event-item.life::before { background: #db61a2; }
        .event-item.benefits::before { background: #7ee787; }
        .event-age {
            font-size: 12px;
            color: #7ee787;
            font-weight: 600;
        }
        .event-type {
            font-size: 14px;
            color: #e6edf3;
        }
        .event-details {
            font-size: 12px;
            color: #8b949e;
        }

        /* Charts Panel */
        .charts-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }
        .summary-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }
        .summary-card .label {
            font-size: 12px;
            color: #8b949e;
            margin-bottom: 4px;
        }
        .summary-card .value {
            font-size: 20px;
            font-weight: 600;
            color: #7ee787;
        }
        .summary-card .value.negative {
            color: #f85149;
        }
        .summary-card .sub {
            font-size: 11px;
            color: #8b949e;
            margin-top: 4px;
        }
        .chart-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 16px;
        }
        .chart-container h3 {
            font-size: 14px;
            color: #8b949e;
            margin-bottom: 12px;
        }
        .chart-wrapper {
            position: relative;
            height: 280px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal h3 {
            color: #58a6ff;
            margin-bottom: 20px;
        }
        .modal-row {
            margin-bottom: 16px;
        }
        .modal-row label {
            display: block;
            font-size: 14px;
            color: #8b949e;
            margin-bottom: 6px;
        }
        .modal-row input, .modal-row select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #30363d;
            border-radius: 6px;
            background: #0d1117;
            color: #e6edf3;
            font-size: 14px;
        }
        .modal-row input:focus, .modal-row select:focus {
            outline: none;
            border-color: #58a6ff;
        }
        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }
        .modal-btn.primary {
            background: #238636;
            color: #fff;
        }
        .modal-btn.primary:hover {
            background: #2ea043;
        }
        .modal-btn.secondary {
            background: #21262d;
            color: #e6edf3;
            border: 1px solid #30363d;
        }
        .modal-btn.secondary:hover {
            background: #30363d;
        }

        /* Data Table */
        .data-table-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
            overflow-x: auto;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .data-table th, .data-table td {
            padding: 8px 12px;
            text-align: right;
            border-bottom: 1px solid #30363d;
        }
        .data-table th {
            background: #21262d;
            color: #8b949e;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        .data-table th:first-child, .data-table td:first-child {
            text-align: left;
        }
        .data-table tr:hover {
            background: #21262d;
        }
        .data-table .phase {
            color: #58a6ff;
            font-size: 11px;
        }
        .data-table .negative {
            color: #f85149;
        }
        .data-table .positive {
            color: #7ee787;
        }

        /* Account type badges */
        .account-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .account-badge.taxable { background: #238636; color: #fff; }
        .account-badge.traditional { background: #1f6feb; color: #fff; }
        .account-badge.roth { background: #a371f7; color: #fff; }
        .account-badge.hsa { background: #f0883e; color: #fff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>FIRE Planner Advanced</h1>

        <div class="top-section">
            <div class="inputs-panel">
                <!-- Personal Info Section -->
                <div class="input-section" id="section-personal">
                    <h2 onclick="toggleSection('personal')">Personal Info</h2>
                    <div class="section-content">
                        <div class="input-row">
                            <label>Current Age</label>
                            <div class="input-with-buttons">
                                <input type="number" id="currentAge" value="30" onchange="calculate()">
                                <div class="btn-group">
                                    <button class="inc-btn" onclick="adjustNum('currentAge', 1)">â–²</button>
                                    <button class="inc-btn" onclick="adjustNum('currentAge', -1)">â–¼</button>
                                </div>
                            </div>
                        </div>
                        <div class="input-row">
                            <label>Retirement Age</label>
                            <div class="input-with-buttons">
                                <input type="number" id="retirementAge" value="50" onchange="calculate()">
                                <div class="btn-group">
                                    <button class="inc-btn" onclick="adjustNum('retirementAge', 1)">â–²</button>
                                    <button class="inc-btn" onclick="adjustNum('retirementAge', -1)">â–¼</button>
                                </div>
                            </div>
                        </div>
                        <div class="input-row">
                            <label>Life Expectancy</label>
                            <div class="input-with-buttons">
                                <input type="number" id="lifeExpectancy" value="85" onchange="calculate()">
                                <div class="btn-group">
                                    <button class="inc-btn" onclick="adjustNum('lifeExpectancy', 1)">â–²</button>
                                    <button class="inc-btn" onclick="adjustNum('lifeExpectancy', -1)">â–¼</button>
                                </div>
                            </div>
                        </div>
                        <div class="input-row">
                            <label>Filing Status</label>
                            <select id="filingStatus" onchange="calculate()">
                                <option value="single">Single</option>
                                <option value="married">Married Filing Jointly</option>
                                <option value="head">Head of Household</option>
                            </select>
                        </div>
                        <div class="input-row">
                            <label>State</label>
                            <select id="stateCode" onchange="calculate()">
                                <option value="CA">California (13.3%)</option>
                                <option value="TX">Texas (0%)</option>
                                <option value="FL">Florida (0%)</option>
                                <option value="NY">New York (10.9%)</option>
                                <option value="WA">Washington (0%)</option>
                                <option value="OTHER">Other (avg 5%)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Income Section -->
                <div class="input-section" id="section-income">
                    <h2 onclick="toggleSection('income')">Income</h2>
                    <div class="section-content">
                        <div class="input-row">
                            <label>Gross Annual Salary</label>
                            <div class="input-with-buttons">
                                <input type="text" id="annualSalary" value="$150,000" onchange="calculate()">
                                <div class="btn-group">
                                    <button class="inc-btn" onclick="adjustCurrency('annualSalary', 5000)">â–²</button>
                                    <button class="inc-btn" onclick="adjustCurrency('annualSalary', -5000)">â–¼</button>
                                </div>
                            </div>
                        </div>
                        <div class="input-row">
                            <label>Annual Raise %</label>
                            <div class="input-with-buttons">
                                <input type="text" id="incomeGrowthRate" value="3%" onchange="calculate()">
                                <div class="btn-group">
                                    <button class="inc-btn" onclick="adjustPercent('incomeGrowthRate', 0.5)">â–²</button>
                                    <button class="inc-btn" onclick="adjustPercent('incomeGrowthRate', -0.5)">â–¼</button>
                                </div>
                            </div>
                        </div>
                        <div class="input-row">
                            <label>Social Security (annual)</label>
                            <div class="input-with-buttons">
                                <input type="text" id="socialSecurity" value="$30,000" onchange="calculate()">
                                <div class="btn-group">
                                    <button class="inc-btn" onclick="adjustCurrency('socialSecurity', 1000)">â–²</button>
                                    <button class="inc-btn" onclick="adjustCurrency('socialSecurity', -1000)">â–¼</button>
                                </div>
                            </div>
                        </div>
                        <div class="input-row">
                            <label>SS Start Age</label>
                            <div class="input-with-buttons">
                                <input type="number" id="ssAge" value="67" onchange="calculate()">
                                <div class="btn-group">
                                    <button class="inc-btn" onclick="adjustNum('ssAge', 1)">â–²</button>
                                    <button class="inc-btn" onclick="adjustNum('ssAge', -1)">â–¼</button>
                                </div>
                            </div>
                        </div>
                        <div class="input-row">
                            <label>SS COLA %</label>
                            <div class="input-with-buttons">
                                <input type="text" id="ssCola" value="2.5%" onchange="calculate()">
                                <div class="btn-group">
                                    <button class="inc-btn" onclick="adjustPercent('ssCola', 0.5)">â–²</button>
                                    <button class="inc-btn" onclick="adjustPercent('ssCola', -0.5)">â–¼</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Expenses Section -->
                <div class="input-section" id="section-expenses">
                    <h2 onclick="toggleSection('expenses')">Expenses</h2>
                    <div class="section-content">
                        <div class="input-row">
                            <label>Monthly Expenses</label>
                            <div class="input-with-buttons">
                                <input type="text" id="monthlyExpenses" value="$4,000" onchange="calculate()">
                                <div class="btn-group">
                                    <button class="inc-btn" onclick="adjustCurrency('monthlyExpenses', 500)">â–²</button>
                                    <button class="inc-btn" onclick="adjustCurrency('monthlyExpenses', -500)">â–¼</button>
                                </div>
                            </div>
                        </div>
                        <div class="input-row">
                            <label>Monthly Rent (if renting)</label>
                            <div class="input-with-buttons">
                                <input type="text" id="monthlyRent" value="$2,500" onchange="calculate()">
                                <div class="btn-group">
                                    <button class="inc-btn" onclick="adjustCurrency('monthlyRent', 100)">â–²</button>
                                    <button class="inc-btn" onclick="adjustCurrency('monthlyRent', -100)">â–¼</button>
                                </div>
                            </div>
                        </div>
                        <div class="input-row">
                            <label>Retirement Monthly Exp.</label>
                            <div class="input-with-buttons">
                                <input type="text" id="retirementExpenses" value="$5,000" onchange="calculate()">
                                <div class="btn-group">
                                    <button class="inc-btn" onclick="adjustCurrency('retirementExpenses', 500)">â–²</button>
                                    <button class="inc-btn" onclick="adjustCurrency('retirementExpenses', -500)">â–¼</button>
                                </div>
                            </div>
                        </div>
                        <div class="input-row">
                            <label>Expense Growth %</label>
                            <div class="input-with-buttons">
                                <input type="text" id="expenseGrowthRate" value="2.5%" onchange="calculate()">
                                <div class="btn-group">
                                    <button class="inc-btn" onclick="adjustPercent('expenseGrowthRate', 0.5)">â–²</button>
                                    <button class="inc-btn" onclick="adjustPercent('expenseGrowthRate', -0.5)">â–¼</button>
                                </div>
                            </div>
                        </div>
                        <div class="input-row">
                            <label>Inflation Rate %</label>
                            <div class="input-with-buttons">
                                <input type="text" id="inflationRate" value="2.5%" onchange="calculate()">
                                <div class="btn-group">
                                    <button class="inc-btn" onclick="adjustPercent('inflationRate', 0.5)">â–²</button>
                                    <button class="inc-btn" onclick="adjustPercent('inflationRate', -0.5)">â–¼</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Investment Accounts Section -->
                <div class="input-section" id="section-accounts">
                    <h2 onclick="toggleSection('accounts')">Investment Accounts</h2>
                    <div class="section-content">
                        <div class="input-row">
                            <label>Default Return %</label>
                            <div class="input-with-buttons">
                                <input type="text" id="annualReturn" value="7%" onchange="calculate()">
                                <div class="btn-group">
                                    <button class="inc-btn" onclick="adjustPercent('annualReturn', 0.5)">â–²</button>
                                    <button class="inc-btn" onclick="adjustPercent('annualReturn', -0.5)">â–¼</button>
                                </div>
                            </div>
                        </div>
                        <div class="item-list" id="accountsList"></div>
                        <button class="add-btn" onclick="openAccountModal()">+ Add Account</button>
                    </div>
                </div>

                <!-- Real Estate Section -->
                <div class="input-section" id="section-realestate">
                    <h2 onclick="toggleSection('realestate')">Real Estate</h2>
                    <div class="section-content">
                        <div class="item-list" id="propertiesList"></div>
                        <button class="add-btn" onclick="openPropertyModal()">+ Add Property</button>
                    </div>
                </div>

                <!-- Life Events Section -->
                <div class="input-section" id="section-events">
                    <h2 onclick="toggleSection('events')">Life Events</h2>
                    <div class="section-content">
                        <div class="event-timeline" id="eventsList"></div>
                        <button class="add-btn" onclick="openEventModal()">+ Add Event</button>
                    </div>
                </div>

                <!-- Display Options -->
                <div class="input-section" id="section-display">
                    <h2 onclick="toggleSection('display')">Display Options</h2>
                    <div class="section-content">
                        <div class="input-row">
                            <label>Show Real Dollars</label>
                            <input type="checkbox" id="showRealDollars" onchange="calculate()" style="width:auto">
                        </div>
                        <div class="input-row">
                            <label>Show Survival Curve</label>
                            <input type="checkbox" id="showSurvival" checked onchange="calculate()" style="width:auto">
                        </div>
                        <div class="input-row">
                            <label>Portfolio Y-Max</label>
                            <div class="input-with-buttons">
                                <input type="text" id="yAxisMax" value="Auto" onchange="calculate()">
                                <div class="btn-group">
                                    <button class="inc-btn" onclick="adjustYMax(500000)">â–²</button>
                                    <button class="inc-btn" onclick="adjustYMax(-500000)">â–¼</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="charts-panel">
                <div class="summary-cards" id="summaryCards"></div>

                <div class="charts-grid">
                    <div class="chart-container">
                        <h3>Net Worth Over Time</h3>
                        <div class="chart-wrapper">
                            <canvas id="netWorthChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>Account Balances by Type</h3>
                        <div class="chart-wrapper">
                            <canvas id="accountsChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>Annual Cash Flow</h3>
                        <div class="chart-wrapper">
                            <canvas id="cashFlowChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>Tax Burden</h3>
                        <div class="chart-wrapper">
                            <canvas id="taxChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="data-table-container">
            <table class="data-table" id="dataTable">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div class="modal-overlay" id="accountModal">
        <div class="modal">
            <h3>Add Investment Account</h3>
            <div class="modal-row">
                <label>Account Type</label>
                <select id="newAccountType">
                    <option value="taxable">Taxable Brokerage</option>
                    <option value="traditional_401k">Traditional 401(k)</option>
                    <option value="roth_401k">Roth 401(k)</option>
                    <option value="traditional_ira">Traditional IRA</option>
                    <option value="roth_ira">Roth IRA</option>
                    <option value="hsa">HSA</option>
                </select>
            </div>
            <div class="modal-row">
                <label>Account Name (optional)</label>
                <input type="text" id="newAccountName" placeholder="e.g., Fidelity 401k">
            </div>
            <div class="modal-row">
                <label>Current Balance</label>
                <input type="text" id="newAccountBalance" value="$0">
            </div>
            <div class="modal-row">
                <label>Monthly Contribution</label>
                <input type="text" id="newAccountContribution" value="$500">
            </div>
            <div class="modal-row" id="employerMatchRow">
                <label>Employer Match % (of salary)</label>
                <input type="text" id="newAccountMatch" value="4%">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeAccountModal()">Cancel</button>
                <button class="modal-btn primary" onclick="addAccount()">Add Account</button>
            </div>
        </div>
    </div>

    <!-- Add Property Modal -->
    <div class="modal-overlay" id="propertyModal">
        <div class="modal">
            <h3>Add Property</h3>
            <div class="modal-row">
                <label>Property Type</label>
                <select id="newPropertyType">
                    <option value="primary">Primary Residence</option>
                    <option value="rental">Rental Property</option>
                </select>
            </div>
            <div class="modal-row">
                <label>Property Name</label>
                <input type="text" id="newPropertyName" placeholder="e.g., Main House">
            </div>
            <div class="modal-row">
                <label>Purchase Age</label>
                <input type="number" id="newPropertyAge" value="35">
            </div>
            <div class="modal-row">
                <label>Purchase Price</label>
                <input type="text" id="newPropertyPrice" value="$500,000">
            </div>
            <div class="modal-row">
                <label>Down Payment</label>
                <input type="text" id="newPropertyDown" value="$100,000">
            </div>
            <div class="modal-row">
                <label>Mortgage Rate %</label>
                <input type="text" id="newPropertyRate" value="6.5%">
            </div>
            <div class="modal-row">
                <label>Mortgage Term (years)</label>
                <input type="number" id="newPropertyTerm" value="30">
            </div>
            <div class="modal-row">
                <label>Appreciation %/year</label>
                <input type="text" id="newPropertyAppreciation" value="3%">
            </div>
            <div class="modal-row">
                <label>Property Tax %</label>
                <input type="text" id="newPropertyTax" value="1.2%">
            </div>
            <div class="modal-row" id="rentalIncomeRow" style="display:none">
                <label>Monthly Rent Income</label>
                <input type="text" id="newPropertyRent" value="$2,500">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closePropertyModal()">Cancel</button>
                <button class="modal-btn primary" onclick="addProperty()">Add Property</button>
            </div>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div class="modal-overlay" id="eventModal">
        <div class="modal">
            <h3>Add Life Event</h3>
            <div class="modal-row">
                <label>Event Type</label>
                <select id="newEventType" onchange="updateEventFields()">
                    <optgroup label="Career">
                        <option value="job_change">Job Change / Raise</option>
                        <option value="retirement">Early Retirement</option>
                        <option value="side_income">Side Income Start</option>
                    </optgroup>
                    <optgroup label="Accounts">
                        <option value="roth_conversion">Roth Conversion</option>
                        <option value="contribution_change">Contribution Change</option>
                    </optgroup>
                    <optgroup label="Life">
                        <option value="marriage">Marriage</option>
                        <option value="child">Child Born</option>
                        <option value="inheritance">Inheritance</option>
                        <option value="windfall">Windfall / Bonus</option>
                    </optgroup>
                </select>
            </div>
            <div class="modal-row">
                <label>At Age</label>
                <input type="number" id="newEventAge" value="40">
            </div>
            <div class="modal-row" id="eventAmountRow">
                <label>Amount</label>
                <input type="text" id="newEventAmount" value="$50,000">
            </div>
            <div class="modal-row" id="eventDescRow">
                <label>Description (optional)</label>
                <input type="text" id="newEventDesc" placeholder="e.g., Promotion to Senior">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeEventModal()">Cancel</button>
                <button class="modal-btn primary" onclick="addEvent()">Add Event</button>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // FIRE PLANNER ADVANCED - EVENT-DRIVEN SIMULATION ENGINE
        // =====================================================

        // ========== ACCOUNT TYPE DEFINITIONS (2024 limits) ==========
        const ACCOUNT_TYPES = {
            taxable: {
                name: 'Taxable Brokerage',
                contributionLimit: Infinity,
                taxTreatment: 'taxable',
                earlyWithdrawalPenalty: 0,
                withdrawalAge: 0,
                icon: 'ðŸ’¼'
            },
            traditional_401k: {
                name: 'Traditional 401(k)',
                contributionLimit: 23000,
                catchUpLimit: 30500,
                catchUpAge: 50,
                taxTreatment: 'pre-tax',
                earlyWithdrawalPenalty: 0.10,
                withdrawalAge: 59.5,
                rmdAge: 73,
                hasEmployerMatch: true,
                icon: 'ðŸ“Š'
            },
            roth_401k: {
                name: 'Roth 401(k)',
                contributionLimit: 23000,
                catchUpLimit: 30500,
                catchUpAge: 50,
                taxTreatment: 'post-tax',
                earlyWithdrawalPenalty: 0.10,
                withdrawalAge: 59.5,
                hasEmployerMatch: true,
                icon: 'ðŸ“ˆ'
            },
            traditional_ira: {
                name: 'Traditional IRA',
                contributionLimit: 7000,
                catchUpLimit: 8000,
                catchUpAge: 50,
                taxTreatment: 'pre-tax',
                earlyWithdrawalPenalty: 0.10,
                withdrawalAge: 59.5,
                rmdAge: 73,
                icon: 'ðŸ¦'
            },
            roth_ira: {
                name: 'Roth IRA',
                contributionLimit: 7000,
                catchUpLimit: 8000,
                catchUpAge: 50,
                taxTreatment: 'post-tax',
                earlyWithdrawalPenalty: 0.10,
                withdrawalAge: 59.5,
                contributionsAccessible: true,
                icon: 'ðŸŒŸ'
            },
            hsa: {
                name: 'HSA',
                contributionLimit: 4150,
                familyLimit: 8300,
                catchUpLimit: 5150,
                catchUpAge: 55,
                taxTreatment: 'triple-tax-free',
                earlyWithdrawalPenalty: 0.20,
                withdrawalAge: 65,
                icon: 'ðŸ¥'
            }
        };

        // ========== TAX BRACKETS (2024) ==========
        const TAX_BRACKETS = {
            single: [
                { min: 0, max: 11600, rate: 0.10 },
                { min: 11600, max: 47150, rate: 0.12 },
                { min: 47150, max: 100525, rate: 0.22 },
                { min: 100525, max: 191950, rate: 0.24 },
                { min: 191950, max: 243725, rate: 0.32 },
                { min: 243725, max: 609350, rate: 0.35 },
                { min: 609350, max: Infinity, rate: 0.37 }
            ],
            married: [
                { min: 0, max: 23200, rate: 0.10 },
                { min: 23200, max: 94300, rate: 0.12 },
                { min: 94300, max: 201050, rate: 0.22 },
                { min: 201050, max: 383900, rate: 0.24 },
                { min: 383900, max: 487450, rate: 0.32 },
                { min: 487450, max: 731200, rate: 0.35 },
                { min: 731200, max: Infinity, rate: 0.37 }
            ],
            head: [
                { min: 0, max: 16550, rate: 0.10 },
                { min: 16550, max: 63100, rate: 0.12 },
                { min: 63100, max: 100500, rate: 0.22 },
                { min: 100500, max: 191950, rate: 0.24 },
                { min: 191950, max: 243700, rate: 0.32 },
                { min: 243700, max: 609350, rate: 0.35 },
                { min: 609350, max: Infinity, rate: 0.37 }
            ]
        };

        const CAPITAL_GAINS_BRACKETS = {
            single: [
                { min: 0, max: 47025, rate: 0 },
                { min: 47025, max: 518900, rate: 0.15 },
                { min: 518900, max: Infinity, rate: 0.20 }
            ],
            married: [
                { min: 0, max: 94050, rate: 0 },
                { min: 94050, max: 583750, rate: 0.15 },
                { min: 583750, max: Infinity, rate: 0.20 }
            ]
        };

        const STATE_TAX_RATES = {
            CA: 0.133, TX: 0, FL: 0, NY: 0.109, WA: 0, OTHER: 0.05
        };

        const STANDARD_DEDUCTION = {
            single: 14600,
            married: 29200,
            head: 21900
        };

        // ========== SIMULATION STATE ==========
        let accounts = [];
        let properties = [];
        let events = [];

        // Chart instances
        let netWorthChart = null;
        let accountsChart = null;
        let cashFlowChart = null;
        let taxChart = null;

        // ========== UTILITY FUNCTIONS ==========
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function parseCurrency(value) {
            return parseFloat(String(value).replace(/[^0-9.-]/g, '')) || 0;
        }

        function formatCurrency(value) {
            return '$' + Math.round(value).toLocaleString();
        }

        function parsePercent(value) {
            return parseFloat(String(value).replace(/[^0-9.-]/g, '')) || 0;
        }

        function formatPercent(value) {
            return value + '%';
        }

        function formatMoney(value) {
            if (value >= 1000000) {
                return '$' + (value / 1000000).toFixed(2) + 'M';
            } else if (value >= 1000) {
                return '$' + (value / 1000).toFixed(0) + 'K';
            }
            return '$' + Math.round(value).toLocaleString();
        }

        // ========== TAX ENGINE ==========
        function calculateFederalTax(income, filingStatus) {
            const brackets = TAX_BRACKETS[filingStatus] || TAX_BRACKETS.single;
            const deduction = STANDARD_DEDUCTION[filingStatus] || STANDARD_DEDUCTION.single;
            const taxableIncome = Math.max(0, income - deduction);

            let tax = 0;
            for (const bracket of brackets) {
                if (taxableIncome > bracket.min) {
                    const taxableInBracket = Math.min(taxableIncome, bracket.max) - bracket.min;
                    tax += taxableInBracket * bracket.rate;
                }
            }
            return tax;
        }

        function calculateStateTax(income, stateCode) {
            const rate = STATE_TAX_RATES[stateCode] || 0.05;
            return income * rate;
        }

        function calculateCapitalGainsTax(gains, totalIncome, filingStatus) {
            const brackets = CAPITAL_GAINS_BRACKETS[filingStatus] || CAPITAL_GAINS_BRACKETS.single;
            let tax = 0;
            for (const bracket of brackets) {
                if (totalIncome > bracket.min) {
                    const gainsInBracket = Math.min(Math.max(0, totalIncome - bracket.min), gains);
                    tax += gainsInBracket * bracket.rate;
                    gains -= gainsInBracket;
                    if (gains <= 0) break;
                }
            }
            return tax;
        }

        function calculateTotalTax(ordinaryIncome, capitalGains, filingStatus, stateCode) {
            const federalOrdinary = calculateFederalTax(ordinaryIncome, filingStatus);
            const federalCapGains = calculateCapitalGainsTax(capitalGains, ordinaryIncome + capitalGains, filingStatus);
            const stateTax = calculateStateTax(ordinaryIncome + capitalGains, stateCode);
            return {
                federal: federalOrdinary + federalCapGains,
                state: stateTax,
                total: federalOrdinary + federalCapGains + stateTax
            };
        }

        // ========== RMD CALCULATION ==========
        const RMD_TABLE = {
            73: 26.5, 74: 25.5, 75: 24.6, 76: 23.7, 77: 22.9, 78: 22.0, 79: 21.1, 80: 20.2,
            81: 19.4, 82: 18.5, 83: 17.7, 84: 16.8, 85: 16.0, 86: 15.2, 87: 14.4, 88: 13.7,
            89: 12.9, 90: 12.2, 91: 11.5, 92: 10.8, 93: 10.1, 94: 9.5, 95: 8.9
        };

        function calculateRMD(balance, age) {
            if (age < 73) return 0;
            const divisor = RMD_TABLE[Math.min(age, 95)] || 8.9;
            return balance / divisor;
        }

        // ========== MORTGAGE CALCULATION ==========
        function calculateMortgagePayment(principal, annualRate, years) {
            if (principal <= 0 || years <= 0) return 0;
            const monthlyRate = annualRate / 100 / 12;
            const numPayments = years * 12;
            if (monthlyRate === 0) return principal / numPayments;
            return principal * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) /
                   (Math.pow(1 + monthlyRate, numPayments) - 1);
        }

        // ========== SURVIVAL PROBABILITY (Gompertz-Makeham) ==========
        function calculateSurvivalProbability(age, lifeExpectancy) {
            const alpha = 0.00003;
            const beta = 0.085;
            const lambda = 0.0001;

            const cumulativeHazard = (alpha / beta) * (Math.exp(beta * age) - 1) + lambda * age;
            const survivalFromBirth = Math.exp(-cumulativeHazard);

            const hazardAtLE = (alpha / beta) * (Math.exp(beta * lifeExpectancy) - 1) + lambda * lifeExpectancy;
            const survivalAtLE = Math.exp(-hazardAtLE);

            const scaleFactor = Math.log(0.5) / Math.log(survivalAtLE);
            const adjustedSurvival = Math.pow(survivalFromBirth, scaleFactor);

            return adjustedSurvival * 100;
        }

        // ========== ACCOUNT MANAGEMENT ==========
        function addAccount() {
            const type = document.getElementById('newAccountType').value;
            const name = document.getElementById('newAccountName').value || ACCOUNT_TYPES[type].name;
            const balance = parseCurrency(document.getElementById('newAccountBalance').value);
            const contribution = parseCurrency(document.getElementById('newAccountContribution').value);
            const match = parsePercent(document.getElementById('newAccountMatch').value) / 100;

            accounts.push({
                id: generateId(),
                type,
                name,
                balance,
                monthlyContribution: contribution,
                employerMatch: ACCOUNT_TYPES[type].hasEmployerMatch ? match : 0,
                contributions: balance, // Track basis for Roth
                earnings: 0
            });

            closeAccountModal();
            renderAccounts();
            calculate();
        }

        function deleteAccount(id) {
            accounts = accounts.filter(a => a.id !== id);
            renderAccounts();
            calculate();
        }

        function renderAccounts() {
            const container = document.getElementById('accountsList');
            container.innerHTML = accounts.map(acc => {
                const typeInfo = ACCOUNT_TYPES[acc.type];
                const badgeClass = acc.type.includes('roth') ? 'roth' :
                                   acc.type.includes('traditional') ? 'traditional' :
                                   acc.type === 'hsa' ? 'hsa' : 'taxable';
                return `
                    <div class="item-card">
                        <div class="item-card-header">
                            <span class="item-card-title">${typeInfo.icon} ${acc.name}</span>
                            <button class="delete-btn" onclick="deleteAccount('${acc.id}')">Ã—</button>
                        </div>
                        <div class="item-card-value">${formatCurrency(acc.balance)}</div>
                        <div class="item-card-details">
                            <div class="item-card-row">
                                <span>Monthly contribution:</span>
                                <span>${formatCurrency(acc.monthlyContribution)}</span>
                            </div>
                            ${acc.employerMatch > 0 ? `
                            <div class="item-card-row">
                                <span>Employer match:</span>
                                <span>${(acc.employerMatch * 100).toFixed(1)}% of salary</span>
                            </div>
                            ` : ''}
                            <div class="item-card-row">
                                <span class="account-badge ${badgeClass}">${typeInfo.taxTreatment}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openAccountModal() {
            document.getElementById('accountModal').classList.add('active');
            updateEmployerMatchVisibility();
        }

        function closeAccountModal() {
            document.getElementById('accountModal').classList.remove('active');
            document.getElementById('newAccountName').value = '';
            document.getElementById('newAccountBalance').value = '$0';
            document.getElementById('newAccountContribution').value = '$500';
        }

        function updateEmployerMatchVisibility() {
            const type = document.getElementById('newAccountType').value;
            const row = document.getElementById('employerMatchRow');
            row.style.display = ACCOUNT_TYPES[type]?.hasEmployerMatch ? 'block' : 'none';
        }
        document.getElementById('newAccountType').addEventListener('change', updateEmployerMatchVisibility);

        // ========== PROPERTY MANAGEMENT ==========
        function addProperty() {
            const type = document.getElementById('newPropertyType').value;
            const name = document.getElementById('newPropertyName').value || (type === 'primary' ? 'Primary Residence' : 'Rental Property');
            const purchaseAge = parseInt(document.getElementById('newPropertyAge').value);
            const price = parseCurrency(document.getElementById('newPropertyPrice').value);
            const downPayment = parseCurrency(document.getElementById('newPropertyDown').value);
            const rate = parsePercent(document.getElementById('newPropertyRate').value);
            const term = parseInt(document.getElementById('newPropertyTerm').value);
            const appreciation = parsePercent(document.getElementById('newPropertyAppreciation').value) / 100;
            const propertyTax = parsePercent(document.getElementById('newPropertyTax').value) / 100;
            const rentalIncome = type === 'rental' ? parseCurrency(document.getElementById('newPropertyRent').value) : 0;

            properties.push({
                id: generateId(),
                type,
                name,
                purchaseAge,
                purchasePrice: price,
                downPayment,
                mortgageRate: rate,
                mortgageTerm: term,
                appreciation,
                propertyTaxRate: propertyTax,
                maintenanceRate: 0.01,
                insurance: 1500,
                rentalIncome,
                // Calculated at purchase
                currentValue: 0,
                mortgageBalance: 0,
                monthlyPayment: 0
            });

            closePropertyModal();
            renderProperties();
            calculate();
        }

        function deleteProperty(id) {
            properties = properties.filter(p => p.id !== id);
            renderProperties();
            calculate();
        }

        function renderProperties() {
            const container = document.getElementById('propertiesList');
            container.innerHTML = properties.map(prop => {
                const icon = prop.type === 'primary' ? 'ðŸ ' : 'ðŸ¢';
                return `
                    <div class="item-card">
                        <div class="item-card-header">
                            <span class="item-card-title">${icon} ${prop.name}</span>
                            <button class="delete-btn" onclick="deleteProperty('${prop.id}')">Ã—</button>
                        </div>
                        <div class="item-card-value">${formatCurrency(prop.purchasePrice)}</div>
                        <div class="item-card-details">
                            <div class="item-card-row">
                                <span>Purchase at age:</span>
                                <span>${prop.purchaseAge}</span>
                            </div>
                            <div class="item-card-row">
                                <span>Down payment:</span>
                                <span>${formatCurrency(prop.downPayment)}</span>
                            </div>
                            <div class="item-card-row">
                                <span>Mortgage:</span>
                                <span>${prop.mortgageTerm}yr @ ${prop.mortgageRate}%</span>
                            </div>
                            ${prop.type === 'rental' ? `
                            <div class="item-card-row">
                                <span>Monthly rent:</span>
                                <span>${formatCurrency(prop.rentalIncome)}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openPropertyModal() {
            document.getElementById('propertyModal').classList.add('active');
        }

        function closePropertyModal() {
            document.getElementById('propertyModal').classList.remove('active');
        }

        document.getElementById('newPropertyType').addEventListener('change', () => {
            const type = document.getElementById('newPropertyType').value;
            document.getElementById('rentalIncomeRow').style.display = type === 'rental' ? 'block' : 'none';
        });

        // ========== EVENT MANAGEMENT ==========
        function addEvent() {
            const type = document.getElementById('newEventType').value;
            const age = parseInt(document.getElementById('newEventAge').value);
            const amount = parseCurrency(document.getElementById('newEventAmount').value);
            const desc = document.getElementById('newEventDesc').value;

            events.push({
                id: generateId(),
                type,
                age,
                amount,
                description: desc
            });

            events.sort((a, b) => a.age - b.age);

            closeEventModal();
            renderEvents();
            calculate();
        }

        function deleteEvent(id) {
            events = events.filter(e => e.id !== id);
            renderEvents();
            calculate();
        }

        function renderEvents() {
            const container = document.getElementById('eventsList');
            const eventLabels = {
                job_change: 'Job Change',
                retirement: 'Early Retirement',
                side_income: 'Side Income',
                roth_conversion: 'Roth Conversion',
                contribution_change: 'Contribution Change',
                marriage: 'Marriage',
                child: 'Child Born',
                inheritance: 'Inheritance',
                windfall: 'Windfall'
            };
            const eventCategories = {
                job_change: 'career', retirement: 'career', side_income: 'career',
                roth_conversion: 'accounts', contribution_change: 'accounts',
                marriage: 'life', child: 'life', inheritance: 'life', windfall: 'life'
            };

            container.innerHTML = events.map(evt => `
                <div class="event-item ${eventCategories[evt.type] || 'life'}">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div>
                            <div class="event-age">Age ${evt.age}</div>
                            <div class="event-type">${eventLabels[evt.type] || evt.type}</div>
                            ${evt.amount ? `<div class="event-details">${formatCurrency(evt.amount)}</div>` : ''}
                            ${evt.description ? `<div class="event-details">${evt.description}</div>` : ''}
                        </div>
                        <button class="delete-btn" onclick="deleteEvent('${evt.id}')">Ã—</button>
                    </div>
                </div>
            `).join('');
        }

        function openEventModal() {
            document.getElementById('eventModal').classList.add('active');
        }

        function closeEventModal() {
            document.getElementById('eventModal').classList.remove('active');
        }

        function updateEventFields() {
            // Could customize fields based on event type
        }

        // ========== INPUT HELPERS ==========
        function adjustNum(id, delta) {
            const input = document.getElementById(id);
            input.value = Math.max(0, parseInt(input.value) + delta);
            calculate();
        }

        function adjustCurrency(id, delta) {
            const input = document.getElementById(id);
            const val = parseCurrency(input.value) + delta;
            input.value = formatCurrency(Math.max(0, val));
            calculate();
        }

        function adjustPercent(id, delta) {
            const input = document.getElementById(id);
            const val = parsePercent(input.value) + delta;
            input.value = formatPercent(Math.max(0, val));
            calculate();
        }

        function adjustYMax(delta) {
            const input = document.getElementById('yAxisMax');
            if (input.value === 'Auto') {
                input.value = formatCurrency(2000000);
            } else {
                const val = parseCurrency(input.value) + delta;
                input.value = val <= 0 ? 'Auto' : formatCurrency(val);
            }
            calculate();
        }

        function toggleSection(name) {
            const section = document.getElementById('section-' + name);
            section.classList.toggle('collapsed');
            section.querySelector('h2').classList.toggle('collapsed');
        }

        // ========== MAIN SIMULATION ==========
        function calculate() {
            const currentAge = parseInt(document.getElementById('currentAge').value) || 30;
            const retirementAge = parseInt(document.getElementById('retirementAge').value) || 50;
            const lifeExpectancy = parseInt(document.getElementById('lifeExpectancy').value) || 85;
            const filingStatus = document.getElementById('filingStatus').value;
            const stateCode = document.getElementById('stateCode').value;

            const annualSalary = parseCurrency(document.getElementById('annualSalary').value);
            const incomeGrowthRate = parsePercent(document.getElementById('incomeGrowthRate').value) / 100;
            const socialSecurity = parseCurrency(document.getElementById('socialSecurity').value);
            const ssAge = parseInt(document.getElementById('ssAge').value) || 67;
            const ssCola = parsePercent(document.getElementById('ssCola').value) / 100;

            const monthlyExpenses = parseCurrency(document.getElementById('monthlyExpenses').value);
            const monthlyRent = parseCurrency(document.getElementById('monthlyRent').value);
            const retirementExpenses = parseCurrency(document.getElementById('retirementExpenses').value);
            const expenseGrowthRate = parsePercent(document.getElementById('expenseGrowthRate').value) / 100;
            const inflationRate = parsePercent(document.getElementById('inflationRate').value) / 100;

            const annualReturn = parsePercent(document.getElementById('annualReturn').value) / 100;
            const showRealDollars = document.getElementById('showRealDollars').checked;
            const showSurvival = document.getElementById('showSurvival').checked;

            const endAge = 100;
            const data = [];

            // Clone accounts for simulation
            let simAccounts = accounts.map(a => ({...a}));
            let simProperties = properties.map(p => ({
                ...p,
                currentValue: 0,
                mortgageBalance: 0,
                monthlyPayment: 0,
                owned: false
            }));

            // Track totals
            let peakNetWorth = 0;
            let peakAge = currentAge;
            let brokeAge = null;

            // Year-by-year simulation
            for (let age = currentAge; age <= endAge; age++) {
                const yearsFromStart = age - currentAge;
                const isRetired = age >= retirementAge;
                const hasSS = age >= ssAge;
                const inflationMultiplier = Math.pow(1 + inflationRate, yearsFromStart);

                // Current income (with growth)
                let currentSalary = isRetired ? 0 : annualSalary * Math.pow(1 + incomeGrowthRate, yearsFromStart);

                // Process events for this age
                const ageEvents = events.filter(e => e.age === age);
                for (const evt of ageEvents) {
                    if (evt.type === 'job_change') {
                        currentSalary = evt.amount;
                    } else if (evt.type === 'windfall' || evt.type === 'inheritance') {
                        // Add to taxable account (or create one)
                        let taxableAcc = simAccounts.find(a => a.type === 'taxable');
                        if (!taxableAcc) {
                            taxableAcc = { id: 'auto-taxable', type: 'taxable', name: 'Taxable', balance: 0, monthlyContribution: 0, employerMatch: 0 };
                            simAccounts.push(taxableAcc);
                        }
                        taxableAcc.balance += evt.amount;
                    } else if (evt.type === 'roth_conversion') {
                        // Move from traditional to Roth (simplified)
                        const tradAcc = simAccounts.find(a => a.type === 'traditional_401k' || a.type === 'traditional_ira');
                        let rothAcc = simAccounts.find(a => a.type === 'roth_ira');
                        if (tradAcc && tradAcc.balance >= evt.amount) {
                            if (!rothAcc) {
                                rothAcc = { id: 'auto-roth', type: 'roth_ira', name: 'Roth IRA', balance: 0, monthlyContribution: 0, employerMatch: 0, contributions: 0 };
                                simAccounts.push(rothAcc);
                            }
                            tradAcc.balance -= evt.amount;
                            rothAcc.balance += evt.amount;
                            rothAcc.contributions += evt.amount; // This becomes accessible after 5 years
                        }
                    }
                }

                // Social Security income
                let ssIncome = 0;
                if (hasSS) {
                    const yearsSinceSSStart = age - ssAge;
                    ssIncome = socialSecurity * Math.pow(1 + ssCola, yearsSinceSSStart);
                }

                // Calculate expenses
                const currentMonthlyExpenses = monthlyExpenses * Math.pow(1 + expenseGrowthRate, yearsFromStart);
                const currentRetirementExpenses = retirementExpenses * Math.pow(1 + expenseGrowthRate, yearsFromStart);
                let annualExpenses = isRetired ? currentRetirementExpenses * 12 : currentMonthlyExpenses * 12;

                // Property handling
                let housingCosts = 0;
                let mortgagePayments = 0;
                let rentalIncome = 0;
                let totalHomeEquity = 0;
                let isRenting = true;

                for (const prop of simProperties) {
                    // Check if buying this year
                    if (age === prop.purchaseAge && !prop.owned) {
                        prop.owned = true;
                        prop.currentValue = prop.purchasePrice;
                        prop.mortgageBalance = prop.purchasePrice - prop.downPayment;
                        prop.monthlyPayment = calculateMortgagePayment(prop.mortgageBalance, prop.mortgageRate, prop.mortgageTerm);

                        // Deduct down payment from accounts
                        let remaining = prop.downPayment + prop.purchasePrice * 0.03; // + closing costs
                        for (const acc of simAccounts) {
                            if (remaining <= 0) break;
                            if (acc.type === 'taxable' && acc.balance > 0) {
                                const take = Math.min(acc.balance, remaining);
                                acc.balance -= take;
                                remaining -= take;
                            }
                        }
                    }

                    if (prop.owned) {
                        if (prop.type === 'primary') isRenting = false;

                        // Appreciation
                        if (age > prop.purchaseAge) {
                            prop.currentValue *= (1 + prop.appreciation);
                        }

                        // Housing costs
                        const propTax = prop.currentValue * prop.propertyTaxRate;
                        const maintenance = prop.purchasePrice * prop.maintenanceRate * inflationMultiplier;
                        housingCosts += propTax + maintenance + prop.insurance;

                        // Mortgage
                        if (prop.mortgageBalance > 0) {
                            const annualMortgage = prop.monthlyPayment * 12;
                            const interestPaid = prop.mortgageBalance * (prop.mortgageRate / 100);
                            const principalPaid = Math.min(annualMortgage - interestPaid, prop.mortgageBalance);
                            prop.mortgageBalance = Math.max(0, prop.mortgageBalance - principalPaid);
                            mortgagePayments += annualMortgage;
                        }

                        // Rental income
                        if (prop.type === 'rental') {
                            rentalIncome += prop.rentalIncome * 12 * 0.9; // 10% vacancy
                        }

                        totalHomeEquity += prop.currentValue - prop.mortgageBalance;
                    }
                }

                // Add rent if no primary residence
                let rentPaid = 0;
                if (isRenting) {
                    rentPaid = monthlyRent * Math.pow(1 + expenseGrowthRate, yearsFromStart) * 12;
                }

                // Total cash needed
                const totalExpenses = annualExpenses + housingCosts + mortgagePayments + rentPaid;

                // Income sources
                const grossIncome = currentSalary + ssIncome + rentalIncome;

                // Account contributions (while working)
                let totalContributions = 0;
                let preTaxContributions = 0;

                if (!isRetired) {
                    for (const acc of simAccounts) {
                        const typeInfo = ACCOUNT_TYPES[acc.type];
                        const limit = age >= (typeInfo.catchUpAge || 50) ? (typeInfo.catchUpLimit || typeInfo.contributionLimit) : typeInfo.contributionLimit;
                        const annualContrib = Math.min(acc.monthlyContribution * 12, limit);

                        // Employer match
                        let matchAmount = 0;
                        if (acc.employerMatch > 0) {
                            matchAmount = currentSalary * acc.employerMatch;
                        }

                        acc.balance += annualContrib + matchAmount;
                        totalContributions += annualContrib;

                        if (typeInfo.taxTreatment === 'pre-tax' || typeInfo.taxTreatment === 'triple-tax-free') {
                            preTaxContributions += annualContrib;
                        }

                        if (acc.type.includes('roth')) {
                            acc.contributions = (acc.contributions || 0) + annualContrib;
                        }
                    }
                }

                // Taxable income
                const taxableIncome = Math.max(0, grossIncome - preTaxContributions);

                // Calculate taxes
                const taxes = calculateTotalTax(taxableIncome, 0, filingStatus, stateCode);
                const afterTaxIncome = grossIncome - taxes.total;

                // Net cash flow
                let netCashFlow = afterTaxIncome - totalExpenses - totalContributions;

                // Apply investment returns to all accounts
                let totalAccountBalance = 0;
                let traditionalBalance = 0;
                let rothBalance = 0;
                let taxableBalance = 0;
                let hsaBalance = 0;

                for (const acc of simAccounts) {
                    acc.balance *= (1 + annualReturn);
                    totalAccountBalance += acc.balance;

                    if (acc.type.includes('traditional')) traditionalBalance += acc.balance;
                    else if (acc.type.includes('roth')) rothBalance += acc.balance;
                    else if (acc.type === 'hsa') hsaBalance += acc.balance;
                    else taxableBalance += acc.balance;
                }

                // Handle withdrawals in retirement
                let withdrawals = 0;
                let withdrawalPenalties = 0;

                if (isRetired && netCashFlow < 0) {
                    let needed = -netCashFlow;

                    // RMDs first (from traditional accounts)
                    for (const acc of simAccounts) {
                        if ((acc.type === 'traditional_401k' || acc.type === 'traditional_ira') && age >= 73) {
                            const rmd = calculateRMD(acc.balance, age);
                            if (rmd > 0) {
                                acc.balance -= rmd;
                                needed -= rmd;
                                withdrawals += rmd;
                            }
                        }
                    }

                    // Withdrawal order: Taxable â†’ Traditional â†’ Roth
                    if (needed > 0) {
                        // 1. Taxable (no penalties)
                        for (const acc of simAccounts) {
                            if (needed <= 0) break;
                            if (acc.type === 'taxable' && acc.balance > 0) {
                                const take = Math.min(acc.balance, needed);
                                acc.balance -= take;
                                needed -= take;
                                withdrawals += take;
                            }
                        }
                    }

                    if (needed > 0) {
                        // 2. Traditional (penalties if < 59.5)
                        for (const acc of simAccounts) {
                            if (needed <= 0) break;
                            if ((acc.type === 'traditional_401k' || acc.type === 'traditional_ira') && acc.balance > 0) {
                                const take = Math.min(acc.balance, needed);
                                acc.balance -= take;
                                needed -= take;
                                withdrawals += take;
                                if (age < 59.5) {
                                    withdrawalPenalties += take * 0.10;
                                }
                            }
                        }
                    }

                    if (needed > 0) {
                        // 3. Roth contributions (no penalty), then earnings
                        for (const acc of simAccounts) {
                            if (needed <= 0) break;
                            if (acc.type.includes('roth') && acc.balance > 0) {
                                const contributions = acc.contributions || 0;
                                const takeFromContrib = Math.min(contributions, needed, acc.balance);
                                if (takeFromContrib > 0) {
                                    acc.balance -= takeFromContrib;
                                    acc.contributions -= takeFromContrib;
                                    needed -= takeFromContrib;
                                    withdrawals += takeFromContrib;
                                }

                                // Earnings (penalty if < 59.5)
                                if (needed > 0 && acc.balance > 0) {
                                    const takeFromEarnings = Math.min(acc.balance, needed);
                                    acc.balance -= takeFromEarnings;
                                    needed -= takeFromEarnings;
                                    withdrawals += takeFromEarnings;
                                    if (age < 59.5) {
                                        withdrawalPenalties += takeFromEarnings * 0.10;
                                    }
                                }
                            }
                        }
                    }

                    if (needed > 0) {
                        // 4. HSA (penalty if non-medical before 65)
                        for (const acc of simAccounts) {
                            if (needed <= 0) break;
                            if (acc.type === 'hsa' && acc.balance > 0) {
                                const take = Math.min(acc.balance, needed);
                                acc.balance -= take;
                                needed -= take;
                                withdrawals += take;
                                if (age < 65) {
                                    withdrawalPenalties += take * 0.20;
                                }
                            }
                        }
                    }
                } else if (netCashFlow > 0 && !isRetired) {
                    // Excess goes to taxable account
                    let taxableAcc = simAccounts.find(a => a.type === 'taxable');
                    if (!taxableAcc && netCashFlow > 100) {
                        taxableAcc = { id: 'auto-taxable', type: 'taxable', name: 'Taxable', balance: 0, monthlyContribution: 0, employerMatch: 0 };
                        simAccounts.push(taxableAcc);
                    }
                    if (taxableAcc) {
                        taxableAcc.balance += netCashFlow;
                    }
                }

                // Recalculate totals after withdrawals
                totalAccountBalance = 0;
                traditionalBalance = 0;
                rothBalance = 0;
                taxableBalance = 0;
                hsaBalance = 0;

                for (const acc of simAccounts) {
                    totalAccountBalance += acc.balance;
                    if (acc.type.includes('traditional')) traditionalBalance += acc.balance;
                    else if (acc.type.includes('roth')) rothBalance += acc.balance;
                    else if (acc.type === 'hsa') hsaBalance += acc.balance;
                    else taxableBalance += acc.balance;
                }

                const netWorth = totalAccountBalance + totalHomeEquity;

                if (netWorth > peakNetWorth) {
                    peakNetWorth = netWorth;
                    peakAge = age;
                }

                if (totalAccountBalance <= 0 && !brokeAge && isRetired) {
                    brokeAge = age;
                }

                const survivalProb = calculateSurvivalProbability(age, lifeExpectancy);

                data.push({
                    age,
                    year: new Date().getFullYear() + yearsFromStart,
                    phase: isRetired ? (hasSS ? 'Retire+SS' : 'Retire') : 'Working',
                    grossIncome,
                    taxes: taxes.total,
                    netIncome: afterTaxIncome,
                    expenses: totalExpenses,
                    contributions: totalContributions,
                    withdrawals,
                    penalties: withdrawalPenalties,
                    netCashFlow,
                    totalAccounts: totalAccountBalance,
                    traditionalBalance,
                    rothBalance,
                    taxableBalance,
                    hsaBalance,
                    homeEquity: totalHomeEquity,
                    netWorth,
                    survivalProb,
                    inflationMultiplier
                });
            }

            // Update charts and summary
            updateSummaryCards(data, retirementAge, ssAge, peakNetWorth, peakAge, brokeAge);
            updateCharts(data, showRealDollars, showSurvival, lifeExpectancy);
            updateDataTable(data, showRealDollars);
        }

        function updateSummaryCards(data, retirementAge, ssAge, peakNetWorth, peakAge, brokeAge) {
            const retireData = data.find(d => d.age === retirementAge);
            const ssData = data.find(d => d.age === ssAge);

            const retireNetWorth = retireData?.netWorth || 0;
            const retireExpenses = retireData?.expenses || 0;
            const swr = retireNetWorth > 0 ? (retireExpenses / retireNetWorth) * 100 : 0;
            const swrSafe = swr > 0 && swr < 4;

            document.getElementById('summaryCards').innerHTML = `
                <div class="summary-card">
                    <div class="label">Net Worth at Retirement (${retirementAge})</div>
                    <div class="value">${formatMoney(retireNetWorth)}</div>
                </div>
                <div class="summary-card">
                    <div class="label">Peak Net Worth</div>
                    <div class="value">${formatMoney(peakNetWorth)}</div>
                    <div class="sub">At age ${peakAge}</div>
                </div>
                <div class="summary-card">
                    <div class="label">Safe Withdrawal Rate</div>
                    <div class="value ${swr === 0 ? '' : (swrSafe ? '' : 'negative')}">${swr.toFixed(1)}%</div>
                    <div class="sub">${swrSafe ? '< 4% is sustainable' : '> 4% may be risky'}</div>
                </div>
                <div class="summary-card">
                    <div class="label">Accounts at SS Start (${ssAge})</div>
                    <div class="value">${formatMoney(ssData?.totalAccounts || 0)}</div>
                </div>
                <div class="summary-card">
                    <div class="label">Funds Last Until</div>
                    <div class="value ${brokeAge ? 'negative' : ''}">${brokeAge ? 'Age ' + brokeAge : 'Age 100+'}</div>
                </div>
            `;
        }

        function updateCharts(data, showRealDollars, showSurvival, lifeExpectancy) {
            const labels = data.map(d => d.age);
            const divisor = row => showRealDollars ? row.inflationMultiplier : 1;

            // Net Worth Chart
            const netWorthCtx = document.getElementById('netWorthChart').getContext('2d');
            if (netWorthChart) netWorthChart.destroy();

            const datasets = [
                {
                    label: 'Net Worth',
                    data: data.map(d => d.netWorth / divisor(d)),
                    borderColor: '#7ee787',
                    backgroundColor: 'rgba(126, 231, 135, 0.1)',
                    fill: true,
                    tension: 0.3
                },
                {
                    label: 'Home Equity',
                    data: data.map(d => d.homeEquity / divisor(d)),
                    borderColor: '#f0883e',
                    backgroundColor: 'rgba(240, 136, 62, 0.1)',
                    fill: true,
                    tension: 0.3
                }
            ];

            if (showSurvival) {
                datasets.push({
                    label: 'Survival %',
                    data: data.map(d => d.survivalProb),
                    borderColor: 'rgba(255, 255, 255, 0.3)',
                    borderDash: [5, 5],
                    fill: false,
                    yAxisID: 'y1',
                    pointRadius: 0
                });
            }

            const yMaxInput = document.getElementById('yAxisMax').value;
            const yMax = yMaxInput === 'Auto' ? undefined : parseCurrency(yMaxInput);

            netWorthChart = new Chart(netWorthCtx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        y: {
                            max: yMax,
                            ticks: { callback: v => formatMoney(v) }
                        },
                        y1: showSurvival ? {
                            position: 'right',
                            min: 0,
                            max: 100,
                            grid: { display: false },
                            ticks: { callback: v => v + '%' }
                        } : undefined
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: ctx => {
                                    if (ctx.dataset.yAxisID === 'y1') return ctx.dataset.label + ': ' + ctx.raw.toFixed(1) + '%';
                                    return ctx.dataset.label + ': ' + formatMoney(ctx.raw);
                                }
                            }
                        }
                    }
                }
            });

            // Account Balances Chart
            const accountsCtx = document.getElementById('accountsChart').getContext('2d');
            if (accountsChart) accountsChart.destroy();

            accountsChart = new Chart(accountsCtx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Traditional (Pre-tax)',
                            data: data.map(d => d.traditionalBalance / divisor(d)),
                            borderColor: '#1f6feb',
                            backgroundColor: 'rgba(31, 111, 235, 0.3)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Roth (Post-tax)',
                            data: data.map(d => d.rothBalance / divisor(d)),
                            borderColor: '#a371f7',
                            backgroundColor: 'rgba(163, 113, 247, 0.3)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Taxable',
                            data: data.map(d => d.taxableBalance / divisor(d)),
                            borderColor: '#238636',
                            backgroundColor: 'rgba(35, 134, 54, 0.3)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'HSA',
                            data: data.map(d => d.hsaBalance / divisor(d)),
                            borderColor: '#f0883e',
                            backgroundColor: 'rgba(240, 136, 62, 0.3)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        y: { stacked: true, ticks: { callback: v => formatMoney(v) } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: { label: ctx => ctx.dataset.label + ': ' + formatMoney(ctx.raw) }
                        }
                    }
                }
            });

            // Cash Flow Chart
            const cashFlowCtx = document.getElementById('cashFlowChart').getContext('2d');
            if (cashFlowChart) cashFlowChart.destroy();

            cashFlowChart = new Chart(cashFlowCtx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Income',
                            data: data.map(d => d.netIncome / divisor(d)),
                            backgroundColor: 'rgba(126, 231, 135, 0.7)'
                        },
                        {
                            label: 'Expenses',
                            data: data.map(d => -d.expenses / divisor(d)),
                            backgroundColor: 'rgba(248, 81, 73, 0.7)'
                        },
                        {
                            label: 'Withdrawals',
                            data: data.map(d => d.withdrawals / divisor(d)),
                            backgroundColor: 'rgba(163, 113, 247, 0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, ticks: { callback: v => formatMoney(v) } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: { label: ctx => ctx.dataset.label + ': ' + formatMoney(Math.abs(ctx.raw)) }
                        }
                    }
                }
            });

            // Tax Chart
            const taxCtx = document.getElementById('taxChart').getContext('2d');
            if (taxChart) taxChart.destroy();

            taxChart = new Chart(taxCtx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Total Tax',
                            data: data.map(d => d.taxes / divisor(d)),
                            borderColor: '#f85149',
                            backgroundColor: 'rgba(248, 81, 73, 0.2)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Penalties',
                            data: data.map(d => d.penalties / divisor(d)),
                            borderColor: '#f0883e',
                            backgroundColor: 'rgba(240, 136, 62, 0.2)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        y: { ticks: { callback: v => formatMoney(v) } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: { label: ctx => ctx.dataset.label + ': ' + formatMoney(ctx.raw) }
                        }
                    }
                }
            });
        }

        function updateDataTable(data, showRealDollars) {
            const thead = document.querySelector('#dataTable thead');
            const tbody = document.querySelector('#dataTable tbody');

            thead.innerHTML = `
                <tr>
                    <th>Age</th>
                    <th>Phase</th>
                    <th>Gross Income</th>
                    <th>Taxes</th>
                    <th>Expenses</th>
                    <th>Contributions</th>
                    <th>Withdrawals</th>
                    <th>Total Accounts</th>
                    <th>Home Equity</th>
                    <th>Net Worth</th>
                    <th>Survival %</th>
                </tr>
            `;

            const divisor = row => showRealDollars ? row.inflationMultiplier : 1;

            tbody.innerHTML = data.map(row => `
                <tr>
                    <td>${row.age}</td>
                    <td class="phase">${row.phase}</td>
                    <td>${formatMoney(row.grossIncome / divisor(row))}</td>
                    <td class="negative">${formatMoney(row.taxes / divisor(row))}</td>
                    <td class="negative">${formatMoney(row.expenses / divisor(row))}</td>
                    <td>${formatMoney(row.contributions / divisor(row))}</td>
                    <td>${formatMoney(row.withdrawals / divisor(row))}</td>
                    <td class="${row.totalAccounts > 0 ? 'positive' : 'negative'}">${formatMoney(row.totalAccounts / divisor(row))}</td>
                    <td>${formatMoney(row.homeEquity / divisor(row))}</td>
                    <td class="${row.netWorth > 0 ? 'positive' : 'negative'}">${formatMoney(row.netWorth / divisor(row))}</td>
                    <td>${row.survivalProb.toFixed(1)}%</td>
                </tr>
            `).join('');
        }

        // ========== INITIALIZATION ==========
        function init() {
            // Add some default accounts
            accounts = [
                {
                    id: generateId(),
                    type: 'traditional_401k',
                    name: '401(k)',
                    balance: 50000,
                    monthlyContribution: 1916, // Max out
                    employerMatch: 0.04,
                    contributions: 50000,
                    earnings: 0
                },
                {
                    id: generateId(),
                    type: 'roth_ira',
                    name: 'Roth IRA',
                    balance: 20000,
                    monthlyContribution: 583, // Max out
                    employerMatch: 0,
                    contributions: 20000,
                    earnings: 0
                }
            ];

            renderAccounts();
            renderProperties();
            renderEvents();
            calculate();
        }

        // Run on load
        init();
    </script>
</body>
</html>
